import{getFirestore as e,doc as t,getDoc as a,setDoc as n,updateDoc as s,deleteDoc as r,collection as d,addDoc as o,getDocs as i,query as c,where as l,orderBy as u,arrayUnion as f,arrayRemove as m,serverTimestamp as v,runTransaction as y}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import{getAuth as p,onAuthStateChanged as h}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{initializeApp as g}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import{cardsData as w,getCardsByRarity as k,getCardByNumber as b,getCardById as E}from"../card-data/cards-data.js";import{createMiniCardHTML as L,createCardChipHTML as I,getRarityColor as $,createCardHTML as x,setup3DCardTracking as B}from"../card-data/card-renderer.js";const M=g({apiKey:"AIzaSyAGcg43F94bWqUuyLH-AjghrAfduEVQ8ZM",authDomain:"overunder-ths.firebaseapp.com",projectId:"overunder-ths",storageBucket:"overunder-ths.firebasestorage.app",messagingSenderId:"690530120785",appId:"1:690530120785:web:36dc297cb517ac76cb7470"}),C=e(M),N=p(M),A=d(C,"mulon_users"),F=d(C,"mulon_trades"),T=d(C,"mulon_banned_devices"),S=d(C,"mulon_banned_emails");window.checkBanStatus=async function(){try{const e=N.currentUser,n=function(){let e=0;const t=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,(new Date).getTimezoneOffset(),navigator.hardwareConcurrency||"unknown",navigator.platform].join("|");for(let a=0;a<t.length;a++)e=(e<<5)-e+t.charCodeAt(a),e&=e;let a=localStorage.getItem("mulon_device_id");return a||(a="dev_"+Date.now()+"_"+Math.random().toString(36).substring(2,15),localStorage.setItem("mulon_device_id",a)),a+"_"+Math.abs(e).toString(36)}();if((await a(t(T,n))).exists())return console.log("Device is banned, redirecting..."),window.location.href="https://parismou.org/PMoU-Procedures/Library/banning",!0;if(e){if(e.email){const n=e.email.toLowerCase().replace(/[.#$[\]]/g,"_");if((await a(t(S,n))).exists())return console.log("Email is banned, redirecting..."),window.location.href="https://parismou.org/PMoU-Procedures/Library/banning",!0}const n=await a(t(A,e.uid));if(n.exists()&&!0===n.data().banned)return console.log("User is banned, redirecting..."),window.location.href="https://parismou.org/PMoU-Procedures/Library/banning",!0}return!1}catch(e){return console.error("Error checking ban status:",e),!1}};let D=null,j=0,K=0,q=[],H=[],O=[],P=[],_="offer",U=[],Y=[],G=null,W=null;const V={showAll:!0,keysForCards:!1,cardsForKeys:!1,moneyForCards:!1,cardsForMoney:!1,cardsForCards:!1};let z=[],R="live",J=[];document.addEventListener("DOMContentLoaded",(()=>{const e=document.querySelectorAll(".live-tab"),r=document.getElementById("liveTradesList"),p=document.getElementById("historyTradesList");e.forEach((t=>{t.addEventListener("click",(()=>{const a=t.dataset.tab;R=a,e.forEach((e=>e.classList.remove("active"))),t.classList.add("active"),"live"===a?(r&&(r.style.display="flex"),p&&(p.style.display="none")):(r&&(r.style.display="none"),p&&(p.style.display="flex"),qe())}))}));const g=document.querySelectorAll(".trade-filter"),k=document.querySelectorAll(".trade-switch"),E=document.getElementById("showAllTradesBtn");function L(){je(document.querySelector(".filter-select")?.value||"newest")}function $(e){if(V.showAll)return!0;const t=e.offer.keys>0,a=e.offer.money>0,n=e.offer.cards&&e.offer.cards.length>0,s=e.ask.keys>0,r=e.ask.money>0,d=e.ask.cards&&e.ask.cards.length>0;if(V.keysForCards&&t&&d)return!0;if(V.cardsForKeys&&n&&s)return!0;if(V.moneyForCards&&a&&d)return!0;if(V.cardsForMoney&&n&&r)return!0;if(V.cardsForCards&&n&&d)return!0;return!(V.keysForCards||V.cardsForKeys||V.moneyForCards||V.cardsForMoney||V.cardsForCards)}E&&E.addEventListener("click",(()=>{V.showAll=!V.showAll,E.classList.toggle("active",V.showAll),V.showAll&&(g.forEach((e=>e.classList.remove("active"))),V.keysForCards=!1,V.cardsForKeys=!1,V.moneyForCards=!1,V.cardsForMoney=!1,V.cardsForCards=!1),L()})),g.forEach((e=>{e.addEventListener("click",(t=>{if(t.target.closest(".trade-switch"))return;const a=e.dataset.type,n=e.classList.contains("reversed");e.classList.toggle("active"),"keys"===a?n?V.cardsForKeys=e.classList.contains("active"):V.keysForCards=e.classList.contains("active"):"money"===a?n?V.cardsForMoney=e.classList.contains("active"):V.moneyForCards=e.classList.contains("active"):"cards"===a&&(V.cardsForCards=e.classList.contains("active"));(V.keysForCards||V.cardsForKeys||V.moneyForCards||V.cardsForMoney||V.cardsForCards)&&(V.showAll=!1,E&&E.classList.remove("active")),L()}))})),k.forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();const a=e.dataset.target,n=e.closest(".trade-filter");if(n){const e=n.classList.contains("active"),t=n.classList.contains("reversed");n.classList.toggle("reversed");const s=document.getElementById(`${a}TradeHint`);if(s){const e=n.classList.contains("reversed");"keys"===a?s.innerHTML=e?"Trading <strong>Cards</strong> for <strong>Keys</strong>":"Trading <strong>Keys</strong> for <strong>Cards</strong>":"money"===a&&(s.innerHTML=e?"Trading <strong>Cards</strong> for <strong>Money</strong>":"Trading <strong>Money</strong> for <strong>Cards</strong>")}e&&("keys"===a?(V.keysForCards=!!t,V.cardsForKeys=!t):"money"===a&&(V.moneyForCards=!!t,V.cardsForMoney=!t),L())}}))}));const M=document.querySelector(".filter-select");M&&M.addEventListener("change",L);const T=document.getElementById("postTradeModal"),S=document.getElementById("cardGalleryModal"),Q=document.querySelector(".action-btn"),Z=document.getElementById("closePostTradeModal"),X=document.getElementById("cancelTradeBtn"),ee=document.getElementById("submitTradeBtn"),te=document.getElementById("selectMyCardsBtn"),ae=document.getElementById("selectAnyCardsBtn"),ne=document.getElementById("closeGalleryModal"),se=document.getElementById("cancelGalleryBtn"),re=document.getElementById("confirmCardsBtn"),de=document.getElementById("offerKeys"),oe=document.getElementById("offerMoney"),ie=document.getElementById("askKeys"),ce=document.getElementById("askMoney"),le=document.getElementById("availableKeys"),ue=document.getElementById("availableMoney"),fe=document.getElementById("offerSelectedCards"),me=document.getElementById("askSelectedCards"),ve=document.getElementById("cardsGallery"),ye=document.getElementById("galleryTitle"),pe=document.getElementById("selectedCount"),he=document.querySelectorAll(".gallery-filter-btn"),ge=document.querySelectorAll(".max-btn");function we(){T.classList.remove("active"),document.body.style.overflow=""}async function ke(){if(!D)return j=0,K=0,q=[],void(H=[]);try{const e=await a(t(A,D.uid));if(e.exists()){const n=e.data();j=n.balance||0,K=n.keys||0,H=n.tradeIds||[];const s=n.readTradeNotifications||[],r=n.completedTradeIds||[];await async function(e,n){if(!D||!e||0===e.length)return void(J=[]);try{const s=e.filter((e=>!n.includes(e)));if(0===s.length)return J=[],void be();J=[];for(const e of s)try{const n=await a(t(F,e));if(n.exists()){const e={id:n.id,...n.data()};e.sellerId!==D.uid&&e.buyerId!==D.uid||J.push(e)}}catch(e){console.warn("Error fetching trade for notification:",e)}be(),J.length>0&&Ee()}catch(e){console.error("Error checking notifications:",e)}}(r,s)}else await n(t(A,D.uid),{balance:500,keys:15,tradeIds:[],createdAt:v()}),j=500,K=15,H=[];await async function(){if(!D)return void(q=[]);try{const e=d(C,"mulon_users",D.uid,"card_inventory"),t=c(e,l("hasCard","==",!0)),a=await i(t);q=[],a.forEach((e=>{q.push({docId:e.id,...e.data()})})),console.log(`Loaded ${q.length} cards for user`)}catch(e){console.error("Error loading user cards:",e),q=[]}}()}catch(e){console.error("Error loading user data:",e)}$e(),je()}function be(){let e=document.getElementById("tradeNotificationBadge");if(J.length>0)if(e)e.querySelector(".badge-count").textContent=J.length,e.style.display="flex";else{const t=document.querySelector(".header-right");t&&(e=document.createElement("div"),e.id="tradeNotificationBadge",e.className="notification-badge",e.innerHTML=`\n            <span class="badge-icon">üîî</span>\n            <span class="badge-count">${J.length}</span>\n          `,e.addEventListener("click",Ee),t.insertBefore(e,t.firstChild))}else e&&(e.style.display="none")}function Ee(){if(0===J.length)return;let e=document.getElementById("tradeNotificationModal");e||(e=document.createElement("div"),e.id="tradeNotificationModal",e.className="modal-overlay",document.body.appendChild(e));const t=J.map((e=>{const t=e.sellerId===D.uid,a=t?e.buyerName:e.sellerName,n=We(e.completedAt);let s=[],r=[];return t?((e.actualOfferKeys>0||e.offer.keys>0)&&s.push(`${e.actualOfferKeys??e.offer.keys} keys`),(e.actualOfferMoney>0||e.offer.money>0)&&s.push(`$${(e.actualOfferMoney??e.offer.money).toFixed(2)}`),e.offer.cards?.length>0&&s.push(`${e.offer.cards.length} card(s)`),e.ask.keys>0&&r.push(`${e.ask.keys} keys`),e.ask.money>0&&r.push(`$${e.ask.money.toFixed(2)}`),e.ask.cards?.length>0&&r.push(`${e.ask.cards.length} card(s)`)):(e.ask.keys>0&&s.push(`${e.ask.keys} keys`),e.ask.money>0&&s.push(`$${e.ask.money.toFixed(2)}`),e.ask.cards?.length>0&&s.push(`${e.ask.cards.length} card(s)`),(e.actualOfferKeys>0||e.offer.keys>0)&&r.push(`${e.actualOfferKeys??e.offer.keys} keys`),(e.actualOfferMoney>0||e.offer.money>0)&&r.push(`$${(e.actualOfferMoney??e.offer.money).toFixed(2)}`),e.offer.cards?.length>0&&r.push(`${e.offer.cards.length} card(s)`)),`\n        <div class="notification-item" data-trade-id="${e.id}">\n          <div class="notification-icon">‚úÖ</div>\n          <div class="notification-content">\n            <div class="notification-title">Trade Completed!</div>\n            <div class="notification-details">\n              <span class="notification-party">with <strong>${a||"Unknown"}</strong></span>\n              <span class="notification-time">${n}</span>\n            </div>\n            <div class="notification-exchange">\n              <span class="gave">You gave: ${s.join(", ")||"Nothing"}</span>\n              <span class="received">You received: ${r.join(", ")||"Nothing"}</span>\n            </div>\n          </div>\n        </div>\n      `})).join("");e.innerHTML=`\n      <div class="modal notification-modal">\n        <div class="modal-header">\n          <h2>üîî Trade Notifications</h2>\n          <button class="modal-close" id="closeNotificationModal">&times;</button>\n        </div>\n        <div class="notification-list">\n          ${t}\n        </div>\n        <div class="modal-footer">\n          <button class="btn btn-primary" id="markAllReadBtn">Mark All as Read</button>\n        </div>\n      </div>\n    `,e.classList.add("active"),document.body.style.overflow="hidden",document.getElementById("closeNotificationModal")?.addEventListener("click",Le),document.getElementById("markAllReadBtn")?.addEventListener("click",Ie),e.addEventListener("click",(t=>{t.target===e&&Le()}))}function Le(){const e=document.getElementById("tradeNotificationModal");e&&(e.classList.remove("active"),document.body.style.overflow="")}async function Ie(){if(D&&0!==J.length)try{const e=J.map((e=>e.id));await s(t(A,D.uid),{readTradeNotifications:f(...e)}),J=[],be(),Le()}catch(e){console.error("Error marking notifications as read:",e)}}function $e(){le&&(le.textContent=K),ue&&(ue.textContent=`$${j.toFixed(2)}`),de&&(de.max=K,de.setAttribute("max",K)),oe&&(oe.max=j,oe.setAttribute("max",j));const e=document.getElementById("userBalance"),t=document.getElementById("userKeys");e&&(e.textContent=`$${j.toFixed(2)}`),t&&(t.innerHTML=`<img src="/bp/EE/assets/ouths/key.png" alt="" class="key-icon"> ${K}`)}function xe(e){_=e,"offer"===e?(ye.textContent="Select Your Cards",U=[...O]):(ye.textContent="Browse All Cards",U=[...P]),Me("all"),Ce(),S.classList.add("active")}function Be(){S.classList.remove("active"),U=[]}function Me(e){if(!ve)return;let t=[...w];"all"!==e&&(t=t.filter((t=>t.rarity===e)));let a={},n={};if("offer"===_){q.forEach((e=>{a[e.cardNumber]=(a[e.cardNumber]||0)+1,n[e.cardNumber]||(n[e.cardNumber]=[]),n[e.cardNumber].push(e.docId)}));const e=q.map((e=>e.cardNumber));t=t.filter((t=>e.includes(t.cardNumber)))}0!==t.length?(ve.innerHTML=t.map(((e,t)=>{let s=!1,r=0;"offer"===_?(r=U.filter((t=>t.cardNumber===e.cardNumber)).length,s=r>0):s=U.includes(e.cardNumber);const d=q.map((e=>e.cardNumber)),o="offer"===_&&!d.includes(e.cardNumber),i=x(e,t,{showBack:!1,size:"small",interactive:!0});let c="",l=1;if("offer"===_){c=(n[e.cardNumber]||[]).join(","),l=a[e.cardNumber]||1}const u=Math.min(l,4),f=u>1?Array(u-1).fill(0).map(((e,t)=>`<div class="stack-layer" style="--stack-index: ${t+1};"></div>`)).join(""):"";return`\n        <div class="gallery-card-wrapper ${s?"selected":""} ${l>1?"has-stack":""}" \n             data-id="${e.id}" data-card-number="${e.cardNumber}" data-doc-ids="${c}" data-owned-count="${l}" ${o?'data-disabled="true"':""}>\n          ${f}\n          ${i}\n          ${"offer"===_&&l>1?`<div class="card-count-badge">${r>0?r+"/":""}${l}</div>`:""}\n        </div>\n      `})).join(""),B(ve),ve.querySelectorAll(".gallery-card-wrapper:not([data-disabled])").forEach((e=>{e.addEventListener("click",(()=>{!function(e,t,a,n){if("offer"===_){const s=U.filter((t=>t.cardNumber===e)).length;if(s>=a)U=U.filter((t=>t.cardNumber!==e)),n.classList.remove("selected");else{const a=t[s];a&&U.push({docId:a,cardNumber:e}),n.classList.add("selected")}const r=n.querySelector(".card-count-badge"),d=U.filter((t=>t.cardNumber===e)).length;r&&a>1&&(r.textContent=d>0?`${d}/${a}`:a),0===d?n.classList.remove("selected"):n.classList.add("selected")}else{const t=U.indexOf(e);t>-1?(U.splice(t,1),n.classList.remove("selected")):(U.push(e),n.classList.add("selected"))}Ce()}(e.dataset.cardNumber,e.dataset.docIds?e.dataset.docIds.split(","):[],parseInt(e.dataset.ownedCount)||1,e)}))}))):ve.innerHTML=`\n        <div class="gallery-empty">\n          <p>${"offer"===_?"You don't own any cards yet":"No cards found"}</p>\n        </div>\n      `}function Ce(){pe&&(pe.textContent=U.length)}function Ne(){fe&&(0!==O.length?(fe.innerHTML=O.map((e=>{const t=w.find((t=>t.cardNumber===e.cardNumber));return t?I(t,e.docId):""})).join(""),fe.querySelectorAll(".chip-remove").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();const a=e.dataset.docId;O=O.filter((e=>e.docId!==a)),Ne(),Fe()}))}))):fe.innerHTML='<p class="no-cards-text">No cards selected</p>')}function Ae(){me&&(0!==P.length?(me.innerHTML=P.map((e=>{const t=w.find((t=>t.cardNumber===e));return t?I(t):""})).join(""),me.querySelectorAll(".chip-remove").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();const a=e.dataset.cardNumber;P=P.filter((e=>e!==a)),Ae(),Fe()}))}))):me.innerHTML='<p class="no-cards-text">No cards selected</p>')}function Fe(){if(!ee)return;const e=parseInt(de?.value)||0,t=parseFloat(oe?.value)||0,a=parseInt(ie?.value)||0,n=parseFloat(ce?.value)||0,s=e>0||t>0||O.length>0,r=a>0||n>0||P.length>0,d=e<=K,o=t<=j,i=q.map((e=>e.docId)),c=O.every((e=>i.includes(e.docId)));ee.disabled=!(s&&r&&d&&o&&c)}async function Te(){try{const e=c(F,l("status","==","active"),u("createdAt","desc")),t=await i(e),a=Y.map((e=>e.id));Y=[];const n=[];t.forEach((e=>{const t={id:e.id,...e.data()};Y.push(t),a.includes(e.id)||n.push(e.id)})),je(),n.length>0&&Ke(n)}catch(e){console.error("Error loading trades:",e),async function(){try{const e=await i(c(F,l("status","==","active")));Y=[],e.forEach((e=>{Y.push({id:e.id,...e.data()})})),Y.sort(((e,t)=>{const a=e.createdAt?.toDate?.()||new Date(e.createdAt);return(t.createdAt?.toDate?.()||new Date(t.createdAt))-a})),je(),Ke()}catch(e){console.error("Error loading trades fallback:",e)}}()}}async function Se(){try{const e=c(F,u("createdAt","desc")),t=await i(e);z=[],t.forEach((e=>{z.push({id:e.id,...e.data()})})),"history"===R&&qe()}catch(e){console.error("Error loading all trades:",e)}}function De(){G&&clearInterval(G),W&&clearInterval(W),Te(),Se(),G=setInterval(Te,2e3),W=setInterval(Se,2e3)}function je(e="newest"){const t=document.querySelector(".marketplace-grid");if(!t)return;let a=Y.filter($);"oldest"===e?a.sort(((e,t)=>(e.createdAt?.toDate?.()||new Date(e.createdAt||0))-(t.createdAt?.toDate?.()||new Date(t.createdAt||0)))):"newest"===e&&a.sort(((e,t)=>{const a=e.createdAt?.toDate?.()||new Date(e.createdAt||0);return(t.createdAt?.toDate?.()||new Date(t.createdAt||0))-a})),0!==a.length?(t.innerHTML=a.map((e=>function(e){const t=D&&e.sellerId===D.uid,a=We(e.createdAt),n=D&&!t&&Ye(e),s=e.offer.keys>0,r=e.offer.money>0,d=e.offer.cards?.length>0,o=e.ask.cards?.length>0;let i="mixed";s&&!r&&!d&&o?i="keys-for-cards":r&&!s&&!d&&o?i="money-for-cards":d&&!s&&!r&&e.ask.keys>0?i="cards-for-keys":d&&!s&&!r&&e.ask.money>0?i="cards-for-money":d&&o&&(i="cards-for-cards");let c="";c=t?'<span class="own-trade-label">Your listing</span>':D?n?`\n        <button class="trade-accept-btn" data-trade-id="${e.id}">\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M20 6L9 17l-5-5"/>\n          </svg>\n          Accept Trade\n        </button>\n      `:'<span class="cannot-accept-hint">Insufficient resources</span>':'<span class="login-hint">Sign in to trade</span>';return`\n      <div class="trade-item" data-trade-id="${e.id}" data-trade-type="${i}">\n        <div class="trade-item-header">\n          <div class="trader-info">\n            <div class="trader-avatar">${e.sellerName?e.sellerName.charAt(0).toUpperCase():"?"}</div>\n            <div class="trader-details">\n              <span class="trader-name">${e.sellerName||"Unknown"}</span>\n              <span class="trade-time">${a}</span>\n            </div>\n          </div>\n          ${t?`\n            <button class="trade-delete-btn" data-trade-id="${e.id}" title="Cancel trade">\n              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>\n              </svg>\n            </button>\n          `:""}\n        </div>\n        \n        <div class="trade-item-body">\n          \x3c!-- Offering Section (Top) --\x3e\n          <div class="trade-section offer-section">\n            <div class="section-label offer-label">\n              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 19V5M5 12l7-7 7 7"/>\n              </svg>\n              Offering\n            </div>\n            ${Oe(e.offer,"offer")}\n          </div>\n          \n          \x3c!-- Divider with arrow --\x3e\n          <div class="trade-divider-line">\n            <div class="divider-arrow">\n              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 5v14M5 12l7 7 7-7"/>\n              </svg>\n            </div>\n          </div>\n          \n          \x3c!-- Wants Section (Bottom) --\x3e\n          <div class="trade-section ask-section">\n            <div class="section-label ask-label">\n              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 5v14M5 12l7 7 7-7"/>\n              </svg>\n              Wants\n            </div>\n            ${Oe(e.ask,"ask")}\n          </div>\n        </div>\n        \n        <div class="trade-item-footer">\n          ${c}\n        </div>\n        \n        <div class="trade-click-hint">\n          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <circle cx="11" cy="11" r="8"/>\n            <path d="m21 21-4.3-4.3"/>\n          </svg>\n          Click for details\n        </div>\n      </div>\n    `}(e))).join(""),t.querySelectorAll(".trade-accept-btn").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();Ve(e.dataset.tradeId)}))})),t.querySelectorAll(".trade-delete-btn").forEach((e=>{e.addEventListener("click",(t=>{t.stopPropagation();ze(e.dataset.tradeId)}))})),t.querySelectorAll(".trade-item").forEach((e=>{e.addEventListener("click",(t=>{if(t.target.closest(".trade-accept-btn")||t.target.closest(".trade-delete-btn"))return;Pe(e.dataset.tradeId)}))}))):t.innerHTML='\n        <div class="empty-marketplace">\n          <div class="empty-icon">üè™</div>\n          <h3>No trades yet</h3>\n          <p>Be the first to post a trade!</p>\n        </div>\n      '}function Ke(e=[]){const t=document.getElementById("liveTradesList");t&&(0!==Y.length?(t.innerHTML=Y.map((t=>He(t,e.includes(t.id),"active"))).join(""),t.querySelectorAll(".live-trade-item").forEach((e=>{e.addEventListener("click",(()=>{Pe(e.dataset.tradeId)}))}))):t.innerHTML='\n        <div class="live-trades-empty">\n          <span class="empty-icon">üì°</span>\n          <p>Waiting for live trades...</p>\n        </div>\n      ')}function qe(){const e=document.getElementById("historyTradesList");if(!e)return;const t=z.filter((e=>!!D&&(e.sellerId===D.uid||e.buyerId===D.uid)));0!==t.length?(e.innerHTML=t.map((e=>He(e,!1,e.status))).join(""),e.querySelectorAll(".live-trade-item").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.tradeId;z.find((e=>e.id===t))&&Pe(t)}))}))):e.innerHTML=`\n        <div class="live-trades-empty">\n          <span class="empty-icon">üìú</span>\n          <p>${D?"No trade history yet":"Sign in to see history"}</p>\n        </div>\n      `}function He(e,t,a){const n=We(e.createdAt);let s=[];e.offer.keys>0&&s.push(`<span class="live-resource"><img src="/bp/EE/assets/ouths/key.png" alt="">${e.offer.keys}</span>`),e.offer.money>0&&s.push(`<span class="live-resource">üíµ$${e.offer.money.toFixed(0)}</span>`),e.offer.cards?.length>0&&s.push(`<span class="live-resource">üé¥${e.offer.cards.length}</span>`);let r=[];e.ask.keys>0&&r.push(`<span class="live-resource"><img src="/bp/EE/assets/ouths/key.png" alt="">${e.ask.keys}</span>`),e.ask.money>0&&r.push(`<span class="live-resource">üíµ$${e.ask.money.toFixed(0)}</span>`),e.ask.cards?.length>0&&r.push(`<span class="live-resource">üé¥${e.ask.cards.length}</span>`);const d="active"===a?"Active":"completed"===a?"Completed":"Cancelled";return`\n      <div class="live-trade-item ${t?"new":""}" data-trade-id="${e.id}">\n        <div class="live-trade-header">\n          <div class="live-trade-avatar">${e.sellerName?e.sellerName.charAt(0).toUpperCase():"?"}</div>\n          <div class="live-trade-meta">\n            <div class="live-trade-name">${e.sellerName||"Unknown"}</div>\n            <div class="live-trade-time">${n}</div>\n          </div>\n          <span class="live-trade-status ${a}">${d}</span>\n        </div>\n        <div class="live-trade-summary">\n          <div class="live-trade-offer">${s.join("")}</div>\n          <span class="live-trade-arrow">‚Üí</span>\n          <div class="live-trade-ask">${r.join("")}</div>\n        </div>\n      </div>\n    `}function Oe(e,t){const{keys:a=0,money:n=0,cards:s=[]}=e;if(!(a>0||n>0||s.length>0))return'<div class="resource-box empty"><span class="empty-text">Nothing</span></div>';let r=`<div class="resource-box ${t}">`;return a>0&&(r+=`\n        <div class="resource-row keys-row">\n          <img src="/bp/EE/assets/ouths/key.png" alt="Keys" class="resource-key-icon">\n          <span class="resource-value">√ó${a}</span>\n        </div>\n      `),n>0&&(r+=`\n        <div class="resource-row money-row">\n          <span class="money-emoji">üíµ</span>\n          <span class="resource-value">$${n.toFixed(2)}</span>\n        </div>\n      `),s.length>0&&(r+='<div class="cards-grid-preview">',s.forEach((e=>{const t="object"==typeof e?e.cardNumber:e,a=w.find((e=>e.cardNumber===t))||w.find((t=>t.id===e));a&&(r+=`\n            <div class="mini-trade-card ${a.rarity||"common"}" data-card-number="${a.cardNumber}">\n              <div class="mini-card-emoji">${a.emoji||"üé¥"}</div>\n              <div class="mini-card-info">\n                <span class="mini-card-name">${a.name}</span>\n                <span class="mini-card-rarity">${a.rarity||"common"}</span>\n              </div>\n            </div>\n          `)})),r+="</div>"),r+="</div>",r}function Pe(e){const t=Y.find((t=>t.id===e));if(!t)return;const a=D&&t.sellerId===D.uid,n=D&&!a&&Ye(t),s=We(t.createdAt);let r=document.getElementById("tradeDetailModal");r||(r=document.createElement("div"),r.id="tradeDetailModal",r.className="modal-overlay",document.body.appendChild(r)),r.innerHTML=`\n      <div class="modal trade-detail-modal">\n        <div class="modal-header">\n          <h2>Trade Details</h2>\n          <button class="modal-close" id="closeTradeDetailModal">&times;</button>\n        </div>\n        \n        <div class="trade-detail-content">\n          <div class="trade-detail-trader">\n            <div class="trader-avatar large">${t.sellerName?t.sellerName.charAt(0).toUpperCase():"?"}</div>\n            <div class="trader-info-detail">\n              <span class="trader-name">${t.sellerName||"Unknown"}</span>\n              <span class="trade-time">${s}</span>\n            </div>\n          </div>\n          \n          <div class="trade-detail-sections">\n            \x3c!-- Offering Section --\x3e\n            <div class="detail-section offer">\n              <h3 class="detail-section-title offer">\n                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M12 19V5M5 12l7-7 7 7"/>\n                </svg>\n                Offering\n              </h3>\n              ${Ue(t.offer)}\n            </div>\n            \n            <div class="detail-divider">\n              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M12 5v14M5 12l7 7 7-7"/>\n              </svg>\n              FOR\n            </div>\n            \n            \x3c!-- Wants Section --\x3e\n            <div class="detail-section ask">\n              <h3 class="detail-section-title ask">\n                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                  <path d="M12 5v14M5 12l7 7 7-7"/>\n                </svg>\n                Wants\n              </h3>\n              ${Ue(t.ask)}\n            </div>\n          </div>\n        </div>\n        \n        <div class="modal-footer">\n          ${a?`\n            <button class="btn btn-danger" id="cancelTradeFromDetail" data-trade-id="${t.id}">\n              Cancel Trade\n            </button>\n          `:n?`\n            <button class="btn btn-primary" id="acceptTradeFromDetail" data-trade-id="${t.id}">\n              Accept Trade\n            </button>\n          `:D?'\n            <span class="cannot-accept-hint">Insufficient resources</span>\n          ':'\n            <span class="login-hint">Sign in to trade</span>\n          '}\n          <button class="btn btn-secondary" id="closeTradeDetailBtn">Close</button>\n        </div>\n      </div>\n    `,r.classList.add("active"),document.body.style.overflow="hidden",document.getElementById("closeTradeDetailModal")?.addEventListener("click",_e),document.getElementById("closeTradeDetailBtn")?.addEventListener("click",_e),document.getElementById("acceptTradeFromDetail")?.addEventListener("click",(()=>{_e(),Ve(e)})),document.getElementById("cancelTradeFromDetail")?.addEventListener("click",(()=>{_e(),ze(e)})),r.addEventListener("click",(e=>{e.target===r&&_e()}))}function _e(){const e=document.getElementById("tradeDetailModal");e&&(e.classList.remove("active"),document.body.style.overflow="")}function Ue(e){const{keys:t=0,money:a=0,cards:n=[]}=e;let s='<div class="detail-resources">';return t>0&&(s+=`\n        <div class="detail-resource keys">\n          <img src="/bp/EE/assets/ouths/key.png" alt="Keys" class="detail-key-icon">\n          <span class="detail-value">${t} Keys</span>\n        </div>\n      `),a>0&&(s+=`\n        <div class="detail-resource money">\n          <span class="detail-money-emoji">üíµ</span>\n          <span class="detail-value">$${a.toFixed(2)}</span>\n        </div>\n      `),n.length>0&&(s+='<div class="detail-cards-grid">',n.forEach((e=>{const t="object"==typeof e?e.cardNumber:e,a=w.find((e=>e.cardNumber===t))||w.find((t=>t.id===e));a&&(s+=x(a,0,{showBack:!1,size:"small",interactive:!1}))})),s+="</div>"),0===t&&0===a&&0===n.length&&(s+='<span class="empty-text">Nothing</span>'),s+="</div>",s}function Ye(e){if(!D)return!1;const t=e.ask.keys||0,a=e.ask.money||0,n=e.ask.cards||[];if(t>K)return!1;if(a>j)return!1;const s=q.map((e=>e.cardNumber));for(const e of n)if(!s.includes(e))return!1;return!0}function Ge(e){return q.find((t=>t.cardNumber===e))}function We(e){if(!e)return"Just now";const t=e.toDate?e.toDate():new Date(e),a=new Date,n=Math.floor((a-t)/1e3);return n<60?"Just now":n<3600?`${Math.floor(n/60)}m ago`:n<86400?`${Math.floor(n/3600)}h ago`:`${Math.floor(n/86400)}d ago`}async function Ve(e){if(!D)return void alert("Please sign in to accept trades.");if("function"==typeof window.checkBanStatus){if(await window.checkBanStatus())return}const a=Y.find((t=>t.id===e));if(!a)return void alert("Trade not found.");if(a.sellerId===D.uid)return void alert("You cannot accept your own trade.");if(!Ye(a))return void alert("You don't have enough resources to accept this trade.");const n="Accept this trade?\n\nYou give:\n"+(a.ask.keys>0?`- ${a.ask.keys} Keys\n`:"")+(a.ask.money>0?`- $${a.ask.money.toFixed(2)}\n`:"")+(a.ask.cards?.length>0?`- ${a.ask.cards.length} Card(s)\n`:"")+"\nYou receive:\n"+(a.offer.keys>0?`+ ${a.offer.keys} Keys\n`:"")+(a.offer.money>0?`+ $${a.offer.money.toFixed(2)}\n`:"")+(a.offer.cards?.length>0?`+ ${a.offer.cards.length} Card(s)\n`:"");if(confirm(n))try{const n=D.uid,r=a.sellerId;await y(C,(async s=>{const d=t(A,n),o=t(A,r),i=t(F,e),c=await s.get(d),l=await s.get(o),u=await s.get(i);if(!u.exists())throw new Error("Trade no longer exists.");if("active"!==u.data().status)throw new Error("Trade is no longer active.");if(!c.exists()||!l.exists())throw new Error("User data not found.");const m=c.data(),y=l.data(),p=a.ask.keys||0,h=a.ask.money||0;if((m.keys||0)<p)throw new Error("Insufficient keys.");if((m.balance||0)<h)throw new Error("Insufficient balance.");const g=a.offer.keys||0,w=a.offer.money||0,k=Math.min(g,y.keys||0),b=Math.min(w,y.balance||0),E=(m.keys||0)-p+k,L=(m.balance||0)-h+b,I=Math.max(0,(y.keys||0)-k+p),$=Math.max(0,(y.balance||0)-b+h);s.update(d,{keys:E,balance:L,completedTradeIds:f(e)}),s.update(o,{keys:I,balance:$,completedTradeIds:f(e)}),s.update(i,{status:"completed",buyerId:n,buyerName:D.displayName||D.email?.split("@")[0]||"Anonymous",completedAt:v(),updatedAt:v(),actualOfferKeys:k,actualOfferMoney:b,sellerNotified:!1,buyerNotified:!1})}));const i=a.offer.cards||[];for(const a of i){const i=t(C,"mulon_users",r,"card_inventory",a.docId);await s(i,{hasCard:!1,tradedAt:v(),tradedTo:n,tradeId:e});const c=d(C,"mulon_users",n,"card_inventory");await o(c,{cardNumber:a.cardNumber,hasCard:!0,obtainedAt:v(),obtainedFrom:"trade",tradedFrom:r,tradeId:e})}const c=a.ask.cards||[];for(const a of c){const i=Ge(a);if(i){const c=t(C,"mulon_users",n,"card_inventory",i.docId);await s(c,{hasCard:!1,tradedAt:v(),tradedTo:r,tradeId:e});const l=d(C,"mulon_users",r,"card_inventory");await o(l,{cardNumber:a,hasCard:!0,obtainedAt:v(),obtainedFrom:"trade",tradedFrom:n,tradeId:e})}}await ke(),alert("Trade completed successfully!")}catch(e){console.error("Error accepting trade:",e),alert(`Failed to complete trade: ${e.message}`)}}async function ze(e){if(!D)return;const a=Y.find((t=>t.id===e));if(a)if(a.sellerId===D.uid){if(confirm("Are you sure you want to cancel this trade listing?"))try{await s(t(F,e),{status:"cancelled",cancelledAt:v(),updatedAt:v()}),await s(t(A,D.uid),{tradeIds:m(e)}),H=H.filter((t=>t!==e)),Y=Y.filter((t=>t.id!==e)),je(),Ke()}catch(e){console.error("Error cancelling trade:",e),alert("Failed to cancel trade. Please try again.")}}else alert("You can only cancel your own trades.")}Q&&Q.addEventListener("click",(()=>{D?function(){O=[],P=[],de&&(de.value=0);oe&&(oe.value=0);ie&&(ie.value=0);ce&&(ce.value=0);Ne(),Ae(),$e(),Fe(),T.classList.add("active"),document.body.style.overflow="hidden"}():alert("Please sign in to post a trade.")})),Z&&Z.addEventListener("click",we),X&&X.addEventListener("click",we),T?.addEventListener("click",(e=>{e.target===T&&we()})),ge.forEach((e=>{e.addEventListener("click",(t=>{t.preventDefault();const a=e.dataset.target;"offerKeys"===a&&de?(de.value=K,de.dispatchEvent(new Event("input"))):"offerMoney"===a&&oe&&(oe.value=j.toFixed(2),oe.dispatchEvent(new Event("input"))),Fe()}))})),de&&(de.addEventListener("input",(()=>{let e=parseInt(de.value)||0;e>K&&(e=K,de.value=e),e<0&&(e=0,de.value=e),Fe()})),de.addEventListener("blur",(()=>{let e=parseInt(de.value)||0;e>K&&(e=K),e<0&&(e=0),de.value=e}))),oe&&(oe.addEventListener("input",(()=>{let e=parseFloat(oe.value)||0;e>j&&(e=j,oe.value=e.toFixed(2)),e<0&&(e=0,oe.value=e.toFixed(2)),Fe()})),oe.addEventListener("blur",(()=>{let e=parseFloat(oe.value)||0;e>j&&(e=j),e<0&&(e=0),oe.value=e.toFixed(2)}))),ie&&ie.addEventListener("input",(()=>{let e=parseInt(ie.value)||0;e<0&&(e=0,ie.value=e),Fe()})),ce&&ce.addEventListener("input",(()=>{let e=parseFloat(ce.value)||0;e<0&&(e=0,ce.value=e.toFixed(2)),Fe()})),te&&te.addEventListener("click",(()=>xe("offer"))),ae&&ae.addEventListener("click",(()=>xe("ask"))),ne&&ne.addEventListener("click",Be),se&&se.addEventListener("click",Be),S?.addEventListener("click",(e=>{e.target===S&&Be()})),he.forEach((e=>{e.addEventListener("click",(()=>{he.forEach((e=>e.classList.remove("active"))),e.classList.add("active"),Me(e.dataset.filter)}))})),re&&re.addEventListener("click",(()=>{"offer"===_?(O=[...U],Ne()):(P=[...U],Ae()),Fe(),Be()})),ee&&ee.addEventListener("click",(async()=>{if(!D)return void alert("Please sign in to post a trade.");if("function"==typeof window.checkBanStatus){if(await window.checkBanStatus())return}const e=parseInt(de?.value)||0,a=parseFloat(oe?.value)||0,n=parseInt(ie?.value)||0,r=parseFloat(ce?.value)||0;if(e>K)return void alert("You don't have enough keys.");if(a>j)return void alert("You don't have enough money.");const d=q.map((e=>e.docId));if(O.every((e=>d.includes(e.docId)))){ee.disabled=!0,ee.textContent="Posting...";try{const d={offer:{keys:e,money:a,cards:O.map((e=>({docId:e.docId,cardNumber:e.cardNumber})))},ask:{keys:n,money:r,cards:[...P]},sellerId:D.uid,sellerName:D.displayName||D.email?.split("@")[0]||"Anonymous",sellerEmail:D.email||"",status:"active",createdAt:v(),updatedAt:v()},i=(await o(F,d)).id;await s(t(A,D.uid),{tradeIds:f(i)}),H.push(i);const c={id:i,...d,createdAt:{toDate:()=>new Date}};Y.unshift(c),je(),Ke([i]),we()}catch(e){console.error("Error posting trade:",e),alert("Failed to post trade. Please try again.")}finally{ee.disabled=!1,ee.textContent="Post Trade"}}else alert("You don't own all the selected cards.")}));const Re=document.getElementById("viewCollectionModal"),Je=document.getElementById("closeCollectionModal"),Qe=document.getElementById("closeCollectionBtn"),Ze=document.querySelector(".see-mycards"),Xe=document.querySelectorAll(".collection-tab"),et=document.querySelectorAll(".collection-filter-btn"),tt=document.getElementById("collectionGrid"),at=document.getElementById("collectionEmpty"),nt=document.getElementById("myCardsCount"),st=document.getElementById("allCardsCount");let rt="my-cards",dt="all";function ot(){Re&&Re.classList.remove("active")}function it(){if(!tt)return;let e=[];if("my-cards"===rt){if(e=q.map((e=>{const t=b(e.cardNumber);return t?{...t,docId:e.docId}:null})).filter((e=>null!==e)),0===e.length)return tt.style.display="none",void(at&&(at.style.display="flex"))}else e=[...w];"all"!==dt&&(e=e.filter((e=>e.rarity===dt))),tt.style.display="grid",at&&(at.style.display="none"),tt.innerHTML=e.map(((e,t)=>{let a=!1;a="all-cards"!==rt||q.some((t=>t.cardNumber===e.cardNumber));return`\n        <div class="collection-card-wrapper ${a?"card-owned":"card-not-owned"}">\n          ${"all-cards"===rt?`<div class="ownership-badge ${a?"owned":"not-owned"}">${a?"‚úì Owned":"‚úó Not Owned"}</div>`:""}\n          ${x(e,t,{showBack:!1,interactive:!0})}\n        </div>\n      `})).join(""),B(tt)}Ze&&Ze.addEventListener("click",(()=>{Re&&(Re.classList.add("active"),nt&&(nt.textContent=q.length),st&&(st.textContent=w.length),it())})),Je&&Je.addEventListener("click",ot),Qe&&Qe.addEventListener("click",ot),Xe.forEach((e=>{e.addEventListener("click",(()=>{rt=e.dataset.tab,Xe.forEach((e=>e.classList.remove("active"))),e.classList.add("active"),it()}))})),et.forEach((e=>{e.addEventListener("click",(()=>{dt=e.dataset.filter,et.forEach((e=>e.classList.remove("active"))),e.classList.add("active"),it()}))})),h(N,(async e=>{if("function"==typeof window.checkBanStatus){if(await window.checkBanStatus())return}D=e,await ke(),De()})),"function"==typeof window.checkBanStatus&&window.checkBanStatus(),De()}));
