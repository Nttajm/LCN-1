import{MulonData,Auth}from"./data.js";const ADMIN_EMAILS=Object.freeze(["joelmulonde81@gmail.com","jordan.herrera@crpusd.org","kaidenchatigny@gmail.com","captrojolmao@gmail.com"]);function isAdmin(e){return!(!e||"string"!=typeof e)&&ADMIN_EMAILS.includes(e.toLowerCase())}function isAccessAllowed(){const e=Auth.currentUser;if(!e)return showToast("Access denied: Not signed in","error"),!1;if(!isAdmin(e.email))return showToast("Access denied: Not an admin account","error"),!1;try{const t=e.email;if(!t||!ADMIN_EMAILS.includes(t.toLowerCase()))return showToast("Access denied: Invalid credentials","error"),!1}catch(e){return showToast("Access denied: Auth verification failed","error"),!1}return!0}let access_allowed=!1;function checkAdminAccess(e){const t=document.getElementById("accessOverlay"),s=document.getElementById("accessMessage"),n=document.getElementById("adminSignInBtn");t&&(access_allowed=!1,e?isAdmin(e.email)?(t.classList.remove("active"),access_allowed=!0):(t.classList.add("active"),s.textContent=`Access denied. "${e.email}" is not an admin account.`,n.style.display="none"):(t.classList.add("active"),s.textContent="Please sign in with an admin account to continue.",n.style.display="flex"))}function showLoading(){const e=document.getElementById("marketList");e&&(e.innerHTML='<div class="loading-state">Loading markets from Firebase...</div>')}async function renderMarketList(){const e=await MulonData.getMarkets(),t=document.getElementById("marketList");if(0===e.length)return void(t.innerHTML='\n      <div class="empty-state">\n        <div class="empty-state-icon">üì≠</div>\n        <p class="empty-state-text">No markets yet. Create your first market!</p>\n      </div>\n    ');const s=[...e].sort(((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)));t.innerHTML=s.map((e=>renderMarketItem(e))).join(""),attachMarketItemListeners()}function renderMarketItem(e){const t=MulonData.categories[e.category]||{icon:"üìä",label:"Other"},s=new Date>new Date(`${e.endDate}T${e.endTime||"23:59"}`),n=!0===e.resolved,a=s&&!n;let o="";if(n){const t="yes"===e.resolvedOutcome?"‚úì YES":"‚úó NO";o=`<span class="market-status ${"yes"===e.resolvedOutcome?"resolved-yes":"resolved-no"}">${t}</span>`}else o=a?'<span class="market-status pending">‚è≥ Pending</span>':'<span class="market-status active">üü¢ Active</span>';const i=e.endTime||"23:59";return`\n    <div class="market-item ${n?"resolved":""} ${a?"pending":""}" data-market-id="${e.id}">\n      <div class="market-item-content">\n        <div class="market-item-header">\n          <div class="market-item-title">${e.title}</div>\n          ${o}\n        </div>\n        <div class="market-item-meta">\n          <span class="market-item-tag ${e.category}">${t.icon} ${t.label}</span>\n          <span class="market-item-price">\n            <span class="yes">${e.yesPrice}¬¢</span> / \n            <span class="no">${e.noPrice}¬¢</span>\n          </span>\n          <span class="market-item-date">Ends ${MulonData.formatDate(e.endDate)} @ ${i}</span>\n          ${e.featured?'<span class="market-item-featured">‚≠ê Featured</span>':""}\n        </div>\n      </div>\n      <div class="market-item-actions">\n        ${n?"":`\n          <button class="btn-icon resolve ${a?"highlight":""}" data-id="${e.id}" title="Resolve Market">\n            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>\n              <polyline points="22 4 12 14.01 9 11.01"></polyline>\n            </svg>\n          </button>\n        `}\n        <button class="btn-icon edit" data-id="${e.id}" title="Edit">\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>\n          </svg>\n        </button>\n        <button class="btn-icon delete" data-id="${e.id}" title="Delete">\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M3 6h18"></path>\n            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>\n            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>\n          </svg>\n        </button>\n      </div>\n    </div>\n  `}function attachMarketItemListeners(){document.querySelectorAll(".btn-icon.edit").forEach((e=>{e.addEventListener("click",(function(){editMarket(this.dataset.id)}))})),document.querySelectorAll(".btn-icon.delete").forEach((e=>{e.addEventListener("click",(function(){showDeleteModal(this.dataset.id)}))})),document.querySelectorAll(".btn-icon.resolve").forEach((e=>{e.addEventListener("click",(function(){showResolveModal(this.dataset.id)}))}))}document.addEventListener("DOMContentLoaded",(async function(){if(Auth.init(),"function"==typeof window.checkBanStatus){if(await window.checkBanStatus())return}const e=document.getElementById("adminSignInBtn");e&&e.addEventListener("click",(async()=>{await Auth.signInWithGoogle()})),Auth.onAuthStateChange((async e=>{if("function"==typeof window.checkBanStatus){if(await window.checkBanStatus())return}checkAdminAccess(e)})),showLoading(),await MulonData.init(),renderMarketList(),populateCategoryDropdown(),renderCategoryList(),renderSuggestionList(),setupForm(),setupCategoryForm(),setupManagementTabs(),setupUsersManagement(),setupWaitlistManagement(),setupPurchasesManagement(),setupDeleteModal(),setupResolveModal(),setupResetButton(),setupTransferButton(),setDefaultDates()}));let isEditMode=!1,editingMarketId=null;function setupForm(){const e=document.getElementById("marketForm"),t=document.getElementById("yesPrice"),s=document.getElementById("noPricePreview"),n=document.getElementById("cancelBtn");t.addEventListener("input",(function(){const e=parseInt(this.value)||0;s.textContent=Math.max(0,100-e)})),n.addEventListener("click",resetForm),e.addEventListener("submit",(async function(e){if(e.preventDefault(),!isAccessAllowed())return;const t={title:document.getElementById("title").value.trim(),subtitle:document.getElementById("subtitle").value.trim(),category:document.getElementById("category").value,yesPrice:parseInt(document.getElementById("yesPrice").value),noPrice:100-parseInt(document.getElementById("yesPrice").value),startDate:document.getElementById("startDate").value,endDate:document.getElementById("endDate").value,endTime:document.getElementById("endTime").value||"15:00",volume:parseInt(document.getElementById("volume").value)||0,featured:document.getElementById("featured").checked},s=MulonData.categories[t.category];if(s&&(t.categoryIcon=s.icon,t.categoryLabel=s.label),!(t.title&&t.category&&t.startDate&&t.endDate))return void showToast("Please fill in all required fields","error");if(t.yesPrice<1||t.yesPrice>99)return void showToast("Yes price must be between 1 and 99","error");if(new Date(t.endDate)<=new Date(t.startDate))return void showToast("End date must be after start date","error");const n=document.getElementById("submitBtn");n.disabled=!0,n.textContent="Saving...";try{isEditMode&&editingMarketId?(await MulonData.updateMarket(editingMarketId,t),showToast("Market updated successfully!","success")):(await MulonData.addMarket(t),showToast("Market created successfully!","success")),await renderMarketList(),resetForm()}catch(e){showToast("Error saving market: "+e.message,"error")}finally{n.disabled=!1,n.textContent=isEditMode?"Save Changes":"Create Market"}}))}function editMarket(e){const t=MulonData.getMarket(e);t&&isAccessAllowed()&&(isEditMode=!0,editingMarketId=e,document.getElementById("marketId").value=e,document.getElementById("title").value=t.title,document.getElementById("subtitle").value=t.subtitle||"",document.getElementById("category").value=t.category,document.getElementById("yesPrice").value=t.yesPrice,document.getElementById("noPricePreview").textContent=t.noPrice,document.getElementById("startDate").value=t.startDate,document.getElementById("endDate").value=t.endDate,document.getElementById("endTime").value=t.endTime||"15:00",document.getElementById("volume").value=t.volume||0,document.getElementById("featured").checked=t.featured||!1,document.getElementById("formTitle").textContent="‚úèÔ∏è Edit Market",document.getElementById("submitBtn").textContent="Save Changes",document.querySelector(".form-panel").classList.add("editing"),showMarketTrades(e),document.querySelector(".form-panel").scrollIntoView({behavior:"smooth"}))}async function showMarketTrades(e){document.getElementById("marketTradesSection").style.display="block",setupTradesTabs();document.getElementById("refreshTradesBtn").onclick=()=>loadMarketTradesAndPositions(e),await loadMarketTradesAndPositions(e)}function setupTradesTabs(){const e=document.querySelectorAll(".trades-tab");e.forEach((t=>{t.addEventListener("click",(function(){e.forEach((e=>e.classList.remove("active"))),this.classList.add("active");const t=this.dataset.tab;document.getElementById("positionsTab").style.display="positions"===t?"block":"none",document.getElementById("tradesTab").style.display="trades"===t?"block":"none"}))}))}async function loadMarketTradesAndPositions(e){const t=document.getElementById("positionsList"),s=document.getElementById("tradesList");t.innerHTML='<div class="trades-loading">Loading positions...</div>',s.innerHTML='<div class="trades-loading">Loading trades...</div>';renderPositions(await MulonData.getMarketPositions(e));renderTrades(await MulonData.getMarketTradesWithUsers(e))}function renderPositions(e){const t=document.getElementById("positionsList");0!==e.length?t.innerHTML=e.map((e=>`\n    <div class="position-item">\n      <div class="position-user">\n        ${e.photoURL?`<img src="${e.photoURL}" alt="" class="position-avatar">`:`<div class="position-avatar-placeholder">${(e.displayName||"A").charAt(0).toUpperCase()}</div>`}\n        <div class="position-user-info">\n          <span class="position-name">${escapeHtml(e.displayName)}</span>\n          <span class="position-email">${escapeHtml(e.email)}</span>\n        </div>\n      </div>\n      <div class="position-details">\n        <span class="position-choice ${e.choice}">${e.choice.toUpperCase()}</span>\n        <span class="position-shares">${e.shares.toFixed(2)} shares</span>\n        <span class="position-cost">$${e.costBasis.toFixed(2)} invested</span>\n      </div>\n    </div>\n  `)).join(""):t.innerHTML='\n      <div class="trades-empty">\n        <span class="trades-empty-icon">üì≠</span>\n        <p>No one has positions in this market yet</p>\n      </div>\n    '}function renderTrades(e){const t=document.getElementById("tradesList");0!==e.length?t.innerHTML=e.map((e=>{const t=new Date(e.timestamp).toLocaleString(),s="buy"===e.side?"Bought":"Sold",n="buy"===e.side?"buy":"sell";return`\n      <div class="trade-item">\n        <div class="trade-user">\n          ${e.user.photoURL?`<img src="${e.user.photoURL}" alt="" class="trade-avatar">`:`<div class="trade-avatar-placeholder">${(e.user.displayName||"A").charAt(0).toUpperCase()}</div>`}\n          <div class="trade-user-info">\n            <span class="trade-name">${escapeHtml(e.user.displayName)}</span>\n            <span class="trade-time">${t}</span>\n          </div>\n        </div>\n        <div class="trade-details">\n          <span class="trade-action ${n}">${s}</span>\n          <span class="trade-choice ${e.choice}">${e.choice.toUpperCase()}</span>\n          <span class="trade-shares">${e.shares.toFixed(2)} @ ${e.price}¬¢</span>\n          <span class="trade-cost">$${e.cost.toFixed(2)}</span>\n        </div>\n      </div>\n    `})).join(""):t.innerHTML='\n      <div class="trades-empty">\n        <span class="trades-empty-icon">üì≠</span>\n        <p>No trades have been made on this market yet</p>\n      </div>\n    '}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function hideMarketTrades(){const e=document.getElementById("marketTradesSection");e&&(e.style.display="none")}function resetForm(){isEditMode=!1,editingMarketId=null,document.getElementById("marketForm").reset(),document.getElementById("marketId").value="",document.getElementById("yesPrice").value=50,document.getElementById("noPricePreview").textContent="50",document.getElementById("formTitle").textContent="‚ûï Create New Market",document.getElementById("submitBtn").textContent="Create Market",document.querySelector(".form-panel").classList.remove("editing"),hideMarketTrades(),setDefaultDates()}function setDefaultDates(){const e=new Date,t=new Date(e);t.setDate(t.getDate()+7),document.getElementById("startDate").value=formatDateForInput(e),document.getElementById("endDate").value=formatDateForInput(t)}function formatDateForInput(e){return e.toISOString().split("T")[0]}let deletingMarketId=null;function setupDeleteModal(){const e=document.getElementById("deleteModal"),t=document.getElementById("cancelDelete"),s=document.getElementById("confirmDelete");t.addEventListener("click",hideDeleteModal),e.addEventListener("click",(function(t){t.target===e&&hideDeleteModal()})),s.addEventListener("click",(async function(){if(isAccessAllowed()){if(deletingMarketId){s.disabled=!0,s.textContent="Deleting...";try{await MulonData.deleteMarket(deletingMarketId),await renderMarketList(),showToast("Market deleted","success"),editingMarketId===deletingMarketId&&resetForm()}catch(e){showToast("Error deleting market","error")}finally{s.disabled=!1,s.textContent="Delete"}}hideDeleteModal()}}))}function showDeleteModal(e){deletingMarketId=e,document.getElementById("deleteModal").classList.add("active")}function hideDeleteModal(){deletingMarketId=null,document.getElementById("deleteModal").classList.remove("active")}function setupResetButton(){document.getElementById("resetBtn").addEventListener("click",(async function(){if(isAccessAllowed()&&confirm("Reset all markets to defaults? This will delete all custom markets.")){this.disabled=!0,this.textContent="Resetting...";try{await MulonData.resetToDefaults(),await renderMarketList(),resetForm(),showToast("Markets reset to defaults","success")}catch(e){showToast("Error resetting markets","error")}finally{this.disabled=!1,this.textContent="Reset to Defaults"}}}))}function setupTransferButton(){const e=document.getElementById("transferBtn");e&&e.addEventListener("click",(async function(){if(isAccessAllowed()&&confirm("Transfer all markets from localStorage to Firebase? This will add any localStorage markets to Firebase.")){this.disabled=!0,this.textContent="Transferring...";try{await MulonData.transferFromLocalStorage()?(await MulonData.refreshMarkets(),await renderMarketList(),showToast("Transfer complete! Markets moved to Firebase.","success")):showToast("No localStorage data to transfer","error")}catch(e){showToast("Error transferring: "+e.message,"error")}finally{this.disabled=!1,this.textContent="Transfer from localStorage"}}}))}let resolvingMarketId=null;function setupResolveModal(){const e=document.getElementById("cancelResolve"),t=document.getElementById("resolveYes"),s=document.getElementById("resolveNo"),n=document.getElementById("resolveModal");e&&e.addEventListener("click",hideResolveModal),n&&n.addEventListener("click",(function(e){e.target===n&&hideResolveModal()})),t&&t.addEventListener("click",(()=>resolveMarket("yes"))),s&&s.addEventListener("click",(()=>resolveMarket("no")))}function showResolveModal(e){const t=MulonData.getMarket(e);if(!t)return;resolvingMarketId=e;const s=document.getElementById("resolveModal"),n=document.getElementById("resolveMarketTitle");n&&(n.textContent=t.title),s&&s.classList.add("active")}function hideResolveModal(){const e=document.getElementById("resolveModal");e&&e.classList.remove("active"),resolvingMarketId=null}async function resolveMarket(e){if(!resolvingMarketId)return;if(!isAccessAllowed())return;if(!MulonData.getMarket(resolvingMarketId))return;const t=document.getElementById("resolveYes"),s=document.getElementById("resolveNo");t&&(t.disabled=!0),s&&(s.disabled=!0);try{const t=await MulonData.resolveMarket(resolvingMarketId,e);t.success?(showToast(`Market resolved as ${e.toUpperCase()}! ${t.payoutCount} positions paid out.`,"success"),hideResolveModal(),await renderMarketList()):showToast("Error resolving market: "+(t.error||"Unknown error"),"error")}catch(e){console.error("Resolution error:",e),showToast("Error resolving market: "+e.message,"error")}finally{t&&(t.disabled=!1),s&&(s.disabled=!1)}}function showToast(e,t="success"){const s=document.getElementById("toast");document.getElementById("toastMessage").textContent=e,s.className="toast "+t,setTimeout((()=>s.classList.add("show")),10),setTimeout((()=>{s.classList.remove("show")}),3e3)}function populateCategoryDropdown(){const e=document.getElementById("category");if(!e)return;const t=MulonData.getCategories();e.innerHTML='<option value="">Select category</option>',Object.entries(t).forEach((([t,s])=>{const n=document.createElement("option");n.value=t,n.textContent=`${s.icon} ${s.label}`,e.appendChild(n)}))}function renderCategoryList(){const e=document.getElementById("categoryList");if(!e)return;const t=MulonData.getCategories();0!==Object.keys(t).length?(e.innerHTML=Object.entries(t).map((([e,t])=>`\n    <div class="category-item" data-category-id="${e}">\n      <span class="category-icon">${t.icon}</span>\n      <span class="category-label">${t.label}</span>\n      <span class="category-id">${e}</span>\n      <button class="btn-icon delete-category" data-id="${e}" title="Delete">\n        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <line x1="18" y1="6" x2="6" y2="18"></line>\n          <line x1="6" y1="6" x2="18" y2="18"></line>\n        </svg>\n      </button>\n    </div>\n  `)).join(""),e.querySelectorAll(".delete-category").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=this.dataset.id;if(confirm(`Delete category "${e}"? Markets using this category won't be deleted but may display incorrectly.`)){(await MulonData.deleteCategory(e)).success?(showToast("Category deleted","success"),renderCategoryList(),populateCategoryDropdown()):showToast("Error deleting category","error")}}))}))):e.innerHTML='<p class="empty-message">No categories yet</p>'}function setupCategoryForm(){const e=document.getElementById("categoryForm");e&&e.addEventListener("submit",(async function(t){if(!isAccessAllowed())return;t.preventDefault();const s=document.getElementById("catId").value.trim().toLowerCase().replace(/\s+/g,"-"),n=document.getElementById("catIcon").value.trim(),a=document.getElementById("catLabel").value.trim();if(!s||!n||!a)return void showToast("Please fill in all fields","error");const o=await MulonData.addCategory(s,n,a,s);o.success?(showToast("Category added!","success"),e.reset(),renderCategoryList(),populateCategoryDropdown()):showToast("Error adding category: "+o.error,"error")}))}let waitlistLoaded=!1,purchasesLoaded=!1;function setupManagementTabs(){const e=document.querySelectorAll(".management-tab"),t={categories:document.getElementById("categoriesTabContent"),waitlist:document.getElementById("waitlistTabContent"),users:document.getElementById("usersTabContent"),suggestions:document.getElementById("suggestionsTabContent"),purchases:document.getElementById("purchasesTabContent")};e.forEach((s=>{s.addEventListener("click",(function(){if(!isAccessAllowed())return;const s=this.dataset.tab;e.forEach((e=>e.classList.remove("active"))),this.classList.add("active"),Object.keys(t).forEach((e=>{t[e]&&(t[e].style.display=e===s?"block":"none",t[e].classList.toggle("active",e===s))})),"users"!==s||usersLoaded||loadAllUsers(),"waitlist"!==s||waitlistLoaded||(loadWaitlist(),waitlistLoaded=!0),"purchases"!==s||purchasesLoaded||(loadPurchases(),purchasesLoaded=!0)}))}))}let usersLoaded=!1,allUsers=[];function setupUsersManagement(){const e=document.getElementById("refreshUsersBtn");e&&e.addEventListener("click",loadAllUsers);const t=document.getElementById("userSearch");t&&t.addEventListener("input",(function(){filterAndRenderUsers(this.value)}));const s=document.getElementById("applyBulkBtn");s&&s.addEventListener("click",applyBulkBalanceAction),document.querySelectorAll("[data-set-amount]").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=parseFloat(this.dataset.setAmount);if(!confirm(`Set ALL users' balance to $${e.toFixed(2)}? This cannot be undone.`))return;this.disabled=!0;const t=this.textContent;this.textContent="...";const s=await MulonData.bulkUpdateBalances(e,"set");this.disabled=!1,this.textContent=t,s.success?(showToast(`Set ${s.updatedCount} users to $${e.toFixed(2)}!`,"success"),await loadAllUsers()):showToast("Error: "+s.error,"error")}))}));const n=document.getElementById("applyBulkKeysBtn");n&&n.addEventListener("click",applyBulkKeysAction),document.querySelectorAll("[data-set-keys]").forEach((e=>{e.addEventListener("click",(async function(){const e=parseInt(this.dataset.setKeys);if(!confirm(`Add ${e} keys to ALL users? This cannot be undone.`))return;this.disabled=!0;const t=this.textContent;this.textContent="...";const s=await MulonData.bulkUpdateKeys(e,"add");this.disabled=!1,this.textContent=t,s.success?(showToast(`Added ${e} keys to ${s.updatedCount} users!`,"success"),await loadAllUsers()):showToast("Error: "+s.error,"error")}))}));const a=document.getElementById("resetAllPositionsBtn");a&&a.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(!confirm("‚ö†Ô∏è Are you SURE you want to reset ALL user positions? This will delete all shares/holdings for every user and CANNOT be undone!"))return;if(!confirm("This is your FINAL confirmation. All positions will be permanently deleted. Continue?"))return;this.disabled=!0,this.textContent="Resetting...";const e=await MulonData.resetAllUsersPositions();this.disabled=!1,this.textContent="Reset ALL User Positions",e.success?(showToast(`Reset positions for ${e.resetCount} users!`,"success"),await loadAllUsers()):showToast("Error: "+e.error,"error")}));const o=document.getElementById("applyBulkCardsBtn");o&&o.addEventListener("click",applyBulkCardsAction);const i=document.getElementById("resetAllCardsBtn");i&&i.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(!confirm("‚ö†Ô∏è Are you SURE you want to delete ALL user cards? This will remove every card from every user and CANNOT be undone!"))return;if(!confirm("This is your FINAL confirmation. All cards will be permanently deleted. Continue?"))return;this.disabled=!0,this.textContent="Resetting...";const e=await MulonData.resetAllUsersCards();this.disabled=!1,this.textContent="Reset ALL User Cards",e.success?(showToast(`Deleted ${e.totalCardsDeleted} cards from ${e.resetCount} users!`,"success"),await loadAllUsers()):showToast("Error: "+e.error,"error")})),setupCardsModal()}async function loadAllUsers(){const e=document.getElementById("usersList");e&&(e.innerHTML='<div class="loading-state">Loading users...</div>'),allUsers=await MulonData.getAllUsers(),usersLoaded=!0,updateUsersStats(),renderUsersList(allUsers)}function updateUsersStats(){const e=document.getElementById("totalUsersCount"),t=document.getElementById("totalBalanceSum"),s=document.getElementById("totalPositionsCount"),n=document.getElementById("totalKeysSum");if(e&&(e.textContent=allUsers.length),t){const e=allUsers.reduce(((e,t)=>e+(t.balance||0)),0);t.textContent=`$${e.toFixed(2)}`}if(s){const e=allUsers.reduce(((e,t)=>e+(t.positions?.length||0)),0);s.textContent=e}if(n){const e=allUsers.reduce(((e,t)=>e+(t.keys||0)),0);n.textContent=e}const a=document.getElementById("totalCardsSum");if(a){const e=allUsers.reduce(((e,t)=>e+(t.ownedCards?.length||0)),0);a.textContent=e}}function filterAndRenderUsers(e){if(!e.trim())return void renderUsersList(allUsers);const t=e.toLowerCase();renderUsersList(allUsers.filter((e=>(e.displayName||"").toLowerCase().includes(t)||(e.email||"").toLowerCase().includes(t))))}function renderUsersList(e){const t=document.getElementById("usersList");t&&(0!==e.length?(t.innerHTML=e.map((e=>`\n    <div class="user-admin-item ${e.banned?"user-banned":""}" data-user-id="${e.id}">\n      ${e.banned?'<span class="banned-indicator" title="User is banned">üö´</span>':""}\n      ${e.photoURL?`<img src="${e.photoURL}" alt="" class="user-admin-avatar">`:`<div class="user-admin-avatar-placeholder">${(e.displayName||"A").charAt(0).toUpperCase()}</div>`}\n      <div class="user-admin-info">\n        <span class="user-admin-name">${escapeHtml(e.displayName)}${e.banned?' <span class="banned-badge">BANNED</span>':""}</span>\n        <span class="user-admin-email">${escapeHtml(e.email)}</span>\n      </div>\n      <button class="user-positions-count ${e.positions.length>0?"has-positions clickable":""}" data-user-id="${e.id}" ${e.positions.length>0?'title="Click to view/edit positions"':""}>\n        ${e.positions.length} position${1!==e.positions.length?"s":""}\n        ${e.positions.length>0?'<span class="edit-icon">‚úèÔ∏è</span>':""}\n      </button>\n      <button class="user-cards-count ${(e.ownedCards||[]).length>0?"has-cards clickable":""}" data-user-id="${e.id}" title="Click to view/edit cards">\n        üÉè ${(e.ownedCards||[]).length} card${1!==(e.ownedCards||[]).length?"s":""}\n        <span class="edit-icon">‚úèÔ∏è</span>\n      </button>\n      <div class="user-admin-balance">\n        <span>$</span>\n        <input type="number" class="user-balance-input" value="${e.balance.toFixed(2)}" step="0.01" data-original="${e.balance.toFixed(2)}">\n      </div>\n      <div class="user-admin-keys">\n        <span>üîë</span>\n        <input type="number" class="user-keys-input" value="${e.keys||0}" step="1" min="0" data-original="${e.keys||0}">\n      </div>\n      <div class="user-admin-actions">\n        <button class="btn-icon save-user" data-user-id="${e.id}" title="Save Balance & Keys">\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <polyline points="20 6 9 17 4 12"></polyline>\n          </svg>\n        </button>\n        <button class="btn-icon reset-positions ${0===e.positions.length?"disabled":""}" data-user-id="${e.id}" title="Reset All Positions" ${0===e.positions.length?"disabled":""}>\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n            <path d="M3 6h18"></path>\n            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>\n            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>\n          </svg>\n        </button>\n        <button class="btn-icon ban-user ${e.banned?"is-banned":""}" data-user-id="${e.id}" data-banned="${e.banned?"true":"false"}" title="${e.banned?"Unban User":"Ban User"}">\n          ${e.banned?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M9 12l2 2 4-4"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>'}\n        </button>\n      </div>\n    </div>\n  `)).join(""),t.querySelectorAll(".user-positions-count.clickable").forEach((e=>{e.addEventListener("click",(function(){const e=this.dataset.userId,t=allUsers.find((t=>t.id===e));t&&t.positions.length>0&&showUserPositionsModal(t)}))})),t.querySelectorAll(".user-cards-count").forEach((e=>{e.addEventListener("click",(async function(){const e=this.dataset.userId,t=allUsers.find((t=>t.id===e));t&&await showUserCardsModal(t)}))})),t.querySelectorAll(".save-user").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=this.dataset.userId,t=this.closest(".user-admin-item"),s=t.querySelector(".user-balance-input"),n=t.querySelector(".user-keys-input"),a=parseFloat(s.value),o=parseInt(n.value);if(isNaN(a)||a<0)return void showToast("Please enter a valid balance","error");if(isNaN(o)||o<0)return void showToast("Please enter a valid keys amount","error");this.disabled=!0;const i=await MulonData.updateUserBalance(e,a),r=await MulonData.updateUserKeys(e,o);if(this.disabled=!1,i.success&&r.success){showToast("Balance & Keys updated!","success"),s.dataset.original=a.toFixed(2),n.dataset.original=o,s.style.borderColor="",n.style.borderColor="";const t=allUsers.findIndex((t=>t.id===e));-1!==t&&(allUsers[t].balance=a,allUsers[t].keys=o,updateUsersStats())}else showToast("Error updating user","error")}))})),t.querySelectorAll(".reset-positions").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(this.disabled)return;const e=this.dataset.userId,t=this.closest(".user-admin-item"),s=t.querySelector(".user-admin-name").textContent;if(!confirm(`Reset all positions for "${s}"? This will delete all their shares and cannot be undone.`))return;this.disabled=!0;if((await MulonData.resetUserPositions(e)).success){showToast("Positions reset!","success");const s=allUsers.findIndex((t=>t.id===e));if(-1!==s){allUsers[s].positions=[],updateUsersStats();const e=t.querySelector(".user-positions-count");e.textContent="0 positions",e.classList.remove("has-positions")}}else showToast("Error resetting positions","error"),this.disabled=!1}))})),t.querySelectorAll(".ban-user").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=this.dataset.userId,t="true"===this.dataset.banned,s=this.closest(".user-admin-item").querySelector(".user-admin-name").textContent.replace(" BANNED","");if(t){if(!confirm(`Unban "${s}"? They will be able to access the site again.`))return;const t=confirm("Also remove device bans for this user?\n\nClick OK to remove device bans, or Cancel to only unban the account.");this.disabled=!0;const n=await MulonData.unbanUser(e,t);if(n.success){showToast("User unbanned!","success");const t=allUsers.findIndex((t=>t.id===e));-1!==t&&(allUsers[t].banned=!1),renderUsersList(allUsers)}else showToast("Error unbanning user: "+n.error,"error"),this.disabled=!1}else{if(!confirm(`‚ö†Ô∏è FULL BAN "${s}"?\n\nThis will:\n‚Ä¢ Set balance to $0\n‚Ä¢ Set keys to 0\n‚Ä¢ Delete all positions\n‚Ä¢ Ban their email permanently\n‚Ä¢ Ban all their devices\n‚Ä¢ They will be redirected away from the site\n\nThis is a PERMANENT action!`))return;const t=prompt("Enter ban reason (optional):");if(null===t)return;this.disabled=!0;const n=await MulonData.banUser(e,t,!0);if(n.success){showToast("üî® User FULLY BANNED! Email & devices blocked.","success");const t=allUsers.findIndex((t=>t.id===e));-1!==t&&(allUsers[t].banned=!0,allUsers[t].balance=0,allUsers[t].keys=0,allUsers[t].positions=[]),updateUsersStats(),renderUsersList(allUsers)}else showToast("Error banning user: "+n.error,"error"),this.disabled=!1}}))})),t.querySelectorAll(".user-balance-input").forEach((e=>{e.addEventListener("input",(function(){const e=parseFloat(this.dataset.original),t=parseFloat(this.value);this.style.borderColor=t!==e?"var(--green-primary)":""}))})),t.querySelectorAll(".user-keys-input").forEach((e=>{e.addEventListener("input",(function(){const e=parseInt(this.dataset.original),t=parseInt(this.value);this.style.borderColor=t!==e?"var(--yellow-primary, #f59e0b)":""}))}))):t.innerHTML='\n      <div class="users-empty">\n        <span class="users-empty-icon">üë•</span>\n        <p>No users found</p>\n      </div>\n    ')}async function applyBulkBalanceAction(){if(!isAccessAllowed())return;const e=document.getElementById("bulkOperation").value,t=parseFloat(document.getElementById("bulkAmount").value);if(isNaN(t))return void showToast("Please enter a valid amount","error");const s={add:`add $${t.toFixed(2)} to`,subtract:`subtract $${t.toFixed(2)} from`,set:`set to $${t.toFixed(2)} for`,multiply:`multiply by ${t} for`};if(!confirm(`Are you sure you want to ${s[e]} ALL ${allUsers.length} users? This cannot be undone.`))return;const n=document.getElementById("applyBulkBtn");n.disabled=!0,n.textContent="Applying...";const a=await MulonData.bulkUpdateBalances(t,e);n.disabled=!1,n.textContent="Apply to All",a.success?(showToast(`Updated ${a.updatedCount} users!`,"success"),document.getElementById("bulkAmount").value="",await loadAllUsers()):showToast("Error updating balances: "+a.error,"error")}async function applyBulkKeysAction(){const e=document.getElementById("bulkKeysOperation").value,t=parseInt(document.getElementById("bulkKeysAmount").value);if(isNaN(t)||t<0)return void showToast("Please enter a valid keys amount","error");if(!confirm(`Are you sure you want to ${{add:`add ${t} keys to`,subtract:`subtract ${t} keys from`,set:`set to ${t} keys for`}[e]} ALL ${allUsers.length} users? This cannot be undone.`))return;const s=document.getElementById("applyBulkKeysBtn");s.disabled=!0,s.textContent="Applying...";const n=await MulonData.bulkUpdateKeys(t,e);s.disabled=!1,s.textContent="Apply to All",n.success?(showToast(`Updated keys for ${n.updatedCount} users!`,"success"),document.getElementById("bulkKeysAmount").value="",await loadAllUsers()):showToast("Error updating keys: "+n.error,"error")}async function applyBulkCardsAction(){if(!isAccessAllowed())return;const e=document.getElementById("bulkCardsOperation").value,t=document.getElementById("bulkCardNumber").value.trim().toUpperCase();if(!t||!t.match(/^#?\d{3}$/))return void showToast("Please enter a valid card number (e.g., #001 or 001)","error");const s=t.startsWith("#")?t:"#"+t;if(!confirm(`Are you sure you want to ${{add:`add card ${s} to`,remove:`remove card ${s} from`}[e]} ALL ${allUsers.length} users? This cannot be undone.`))return;const n=document.getElementById("applyBulkCardsBtn");let a;if(n.disabled=!0,n.textContent="Applying...",a="add"===e?await MulonData.bulkAddCardToAllUsers({cardNumber:s}):await MulonData.bulkRemoveCardFromAllUsers(s),n.disabled=!1,n.textContent="Apply to All",a.success){showToast("add"===e?`Added card ${s} to ${a.updatedCount} users!`:`Removed ${a.cardsRemoved||0} cards from ${a.updatedCount} users!`,"success"),document.getElementById("bulkCardNumber").value="",await loadAllUsers()}else showToast("Error: "+a.error,"error")}let currentCardsUser=null;function setupCardsModal(){const e=document.getElementById("cardsModal"),t=document.getElementById("closeCardsModal"),s=document.getElementById("cancelCardsModal"),n=document.getElementById("resetUserCardsModal"),a=document.getElementById("addCardToUserBtn");t&&t.addEventListener("click",closeCardsModal),s&&s.addEventListener("click",closeCardsModal),n&&n.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(!currentCardsUser)return;if(!confirm(`Delete ALL cards for "${currentCardsUser.displayName}"? This cannot be undone.`))return;this.disabled=!0;const e=await MulonData.resetUserCards(currentCardsUser.id);if(this.disabled=!1,e.success){showToast("All cards deleted!","success");const e=allUsers.findIndex((e=>e.id===currentCardsUser.id));-1!==e&&(allUsers[e].ownedCards=[],updateUsersStats()),currentCardsUser.ownedCards=[],renderCardsModalList([]),renderUsersList(allUsers)}else showToast("Error: "+e.error,"error")})),a&&a.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(!currentCardsUser)return;const e=document.getElementById("addCardNumber"),t=e.value.trim().toUpperCase();if(!t||!t.match(/^#?\d{3}$/))return void showToast("Please enter a valid card number (e.g., #001 or 001)","error");const s=t.startsWith("#")?t:"#"+t;this.disabled=!0;const n=await MulonData.addCardToUser(currentCardsUser.id,{cardNumber:s});if(this.disabled=!1,n.success){showToast(`Card ${s} added!`,"success"),e.value="";const t={cardNumber:s,addedAt:(new Date).toISOString(),addedBy:"admin"},n=allUsers.findIndex((e=>e.id===currentCardsUser.id));-1!==n&&(allUsers[n].ownedCards.push(t),updateUsersStats()),currentCardsUser.ownedCards.push(t),renderCardsModalList(currentCardsUser.ownedCards),renderUsersList(allUsers)}else showToast("Error: "+n.error,"error")})),e&&e.addEventListener("click",(function(t){t.target===e&&closeCardsModal()}))}async function showUserCardsModal(e){currentCardsUser=e;const t=document.getElementById("cardsModal"),s=document.getElementById("cardsModalUser");document.getElementById("cardsModalList").innerHTML='<div class="loading-state">Loading cards...</div>',s.innerHTML=`\n    <div class="modal-user-info">\n      ${e.photoURL?`<img src="${e.photoURL}" alt="" class="modal-user-avatar">`:`<div class="modal-user-avatar-placeholder">${(e.displayName||"A").charAt(0).toUpperCase()}</div>`}\n      <div class="modal-user-details">\n        <span class="modal-user-name">${escapeHtml(e.displayName)}</span>\n        <span class="modal-user-email">${escapeHtml(e.email)}</span>\n        <span class="modal-user-cards" id="modalCardsCount">Cards: Loading...</span>\n      </div>\n    </div>\n  `;const n=document.getElementById("addCardNumber");n&&(n.value=""),t.classList.add("active");const a=await MulonData.getUserCards(e.id);e.ownedCards=a,currentCardsUser.ownedCards=a;const o=allUsers.findIndex((t=>t.id===e.id));-1!==o&&(allUsers[o].ownedCards=a);const i=document.getElementById("modalCardsCount");i&&(i.textContent=`Cards: ${a.length}`),renderCardsModalList(a)}function closeCardsModal(){document.getElementById("cardsModal").classList.remove("active"),currentCardsUser=null}function renderCardsModalList(e){const t=document.getElementById("cardsModalList");if(!e||0===e.length)return void(t.innerHTML='<p class="empty-message">No cards owned</p>');const s={};e.forEach((e=>{const t=e.cardNumber||"Unknown";s[t]=(s[t]||0)+1})),t.innerHTML=Object.entries(s).map((([e,t])=>`\n    <div class="card-edit-item" data-card-number="${e}">\n      <div class="card-info">\n        <span class="card-number">${escapeHtml(e)}</span>\n        ${t>1?`<span class="card-count">√ó${t}</span>`:""}\n      </div>\n      <button class="btn btn-sm btn-danger remove-card-btn" data-card-number="${e}" title="Remove one">\n        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n          <path d="M3 6h18"></path>\n          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>\n          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>\n        </svg>\n      </button>\n    </div>\n  `)).join(""),t.querySelectorAll(".remove-card-btn").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(!currentCardsUser)return;const e=this.dataset.cardNumber;this.disabled=!0;const t=await MulonData.removeCardFromUser(currentCardsUser.id,e);if(this.disabled=!1,t.success){showToast(`Card ${e} removed!`,"success");const t=allUsers.findIndex((e=>e.id===currentCardsUser.id));if(-1!==t){const s=allUsers[t].ownedCards.findIndex((t=>t.cardNumber===e));-1!==s&&allUsers[t].ownedCards.splice(s,1),updateUsersStats()}const s=currentCardsUser.ownedCards.findIndex((t=>t.cardNumber===e));-1!==s&&currentCardsUser.ownedCards.splice(s,1),renderCardsModalList(currentCardsUser.ownedCards),renderUsersList(allUsers)}else showToast("Error: "+t.error,"error")}))}))}let currentPositionsUser=null;function showUserPositionsModal(e){currentPositionsUser=e;const t=document.getElementById("positionsModal"),s=document.getElementById("positionsModalUser");document.getElementById("positionsModalList");s.innerHTML=`\n    <div class="modal-user-info">\n      ${e.photoURL?`<img src="${e.photoURL}" alt="" class="modal-user-avatar">`:`<div class="modal-user-avatar-placeholder">${(e.displayName||"A").charAt(0).toUpperCase()}</div>`}\n      <div class="modal-user-details">\n        <span class="modal-user-name">${escapeHtml(e.displayName)}</span>\n        <span class="modal-user-email">${escapeHtml(e.email)}</span>\n        <span class="modal-user-balance">Balance: $${e.balance.toFixed(2)}</span>\n      </div>\n    </div>\n  `,renderPositionsModalList(e.positions),setupPositionsModalListeners(),t.classList.add("active")}function renderPositionsModalList(e){const t=document.getElementById("positionsModalList");e&&0!==e.length?t.innerHTML=e.map(((e,t)=>{const s=MulonData.getMarket(e.marketId),n=s?s.title:"Unknown Market";return`\n      <div class="position-edit-item" data-market-id="${e.marketId}" data-index="${t}">\n        <div class="position-edit-header">\n          <span class="position-market-title">${escapeHtml(n)}</span>\n          <span class="position-choice-badge ${e.choice}">${e.choice.toUpperCase()}</span>\n        </div>\n        <div class="position-edit-fields">\n          <div class="position-field">\n            <label>Shares</label>\n            <input type="number" class="position-shares-input" value="${e.shares}" step="0.01" min="0" data-field="shares">\n          </div>\n          <div class="position-field">\n            <label>Cost Basis ($)</label>\n            <input type="number" class="position-cost-input" value="${e.costBasis?.toFixed(2)||0}" step="0.01" min="0" data-field="costBasis">\n          </div>\n          <div class="position-field">\n            <label>Avg Price (¬¢)</label>\n            <input type="number" class="position-avgprice-input" value="${e.avgPrice||50}" step="1" min="1" max="99" data-field="avgPrice">\n          </div>\n        </div>\n        <div class="position-edit-actions">\n          <button class="btn btn-sm btn-primary save-position-btn" data-market-id="${e.marketId}">Save</button>\n          <button class="btn btn-sm btn-danger delete-position-btn" data-market-id="${e.marketId}">Delete</button>\n        </div>\n      </div>\n    `})).join(""):t.innerHTML='<p class="empty-message">No positions</p>'}function setupPositionsModalListeners(){const e=document.getElementById("positionsModal"),t=document.getElementById("closePositionsModal"),s=document.getElementById("cancelPositionsModal"),n=document.getElementById("resetUserPositionsModal"),a=()=>{e.classList.remove("active"),currentPositionsUser=null};t.onclick=a,s.onclick=a,e.onclick=t=>{t.target===e&&a()},n.onclick=async()=>{if(!isAccessAllowed())return;if(!currentPositionsUser)return;if(!confirm(`Reset ALL positions for ${currentPositionsUser.displayName}? This cannot be undone.`))return;n.disabled=!0,n.textContent="Resetting...";const e=await MulonData.resetUserPositions(currentPositionsUser.id);n.disabled=!1,n.textContent="Reset All Positions",e.success?(showToast("All positions reset!","success"),a(),await loadAllUsers()):showToast("Error: "+e.error,"error")},document.querySelectorAll(".save-position-btn").forEach((e=>{e.onclick=async function(){if(!isAccessAllowed())return;const e=this.dataset.marketId,t=this.closest(".position-edit-item"),s=parseFloat(t.querySelector('[data-field="shares"]').value),n=parseFloat(t.querySelector('[data-field="costBasis"]').value),a=parseInt(t.querySelector('[data-field="avgPrice"]').value);if(isNaN(s)||s<0)return void showToast("Invalid shares value","error");this.disabled=!0,this.textContent="Saving...";const o=await MulonData.updateUserPosition(currentPositionsUser.id,e,{shares:Math.round(100*s)/100,costBasis:Math.round(100*n)/100,avgPrice:a});if(this.disabled=!1,this.textContent="Save",o.success){showToast("Position updated!","success");const t=allUsers.findIndex((e=>e.id===currentPositionsUser.id));if(-1!==t){const o=allUsers[t].positions.findIndex((t=>t.marketId===e));-1!==o&&(allUsers[t].positions[o].shares=s,allUsers[t].positions[o].costBasis=n,allUsers[t].positions[o].avgPrice=a)}}else showToast("Error: "+o.error,"error")}})),document.querySelectorAll(".delete-position-btn").forEach((e=>{e.onclick=async function(){if(!isAccessAllowed())return;const e=this.dataset.marketId,t=this.closest(".position-edit-item").querySelector(".position-market-title").textContent;if(!confirm(`Delete position for "${t}"?`))return;this.disabled=!0,this.textContent="Deleting...";const s=await MulonData.deleteUserPosition(currentPositionsUser.id,e);if(s.success){showToast("Position deleted!","success");const t=allUsers.findIndex((e=>e.id===currentPositionsUser.id));-1!==t&&(allUsers[t].positions=allUsers[t].positions.filter((t=>t.marketId!==e)),currentPositionsUser.positions=allUsers[t].positions,renderPositionsModalList(currentPositionsUser.positions),setupPositionsModalListeners(),updateUsersStats(),0===currentPositionsUser.positions.length&&(document.getElementById("positionsModal").classList.remove("active"),await loadAllUsers()))}else this.disabled=!1,this.textContent="Delete",showToast("Error: "+s.error,"error")}}))}async function renderSuggestionList(){const e=document.getElementById("suggestionList"),t=document.getElementById("suggestionCount"),s=document.getElementById("suggestionBadge");if(!e)return;const n=await MulonData.getSuggestions(),a=n.filter((e=>"pending"===e.status));t&&(t.textContent=a.length),s&&(s.textContent=a.length,s.style.display=a.length>0?"inline":"none"),0!==n.length?(e.innerHTML=n.map((e=>{const t=e.category?MulonData.getCategory(e.category):null,s=t?`<span class="suggestion-category">${t.icon} ${t.label}</span>`:"",n=new Date(e.createdAt).toLocaleDateString();let a="";return"approved"===e.status?a='<span class="suggestion-status approved">‚úì Approved</span>':"rejected"===e.status&&(a='<span class="suggestion-status rejected">‚úó Rejected</span>'),`\n      <div class="suggestion-item ${e.status}" data-id="${e.id}">\n        <div class="suggestion-content">\n          <div class="suggestion-header">\n            <span class="suggestion-title">${e.title}</span>\n            ${a}\n          </div>\n          <div class="suggestion-meta">\n            ${s}\n            <span class="suggestion-user">by ${e.userName||e.userEmail||"Anonymous"}</span>\n            <span class="suggestion-date">${n}</span>\n          </div>\n          ${e.reason?`<p class="suggestion-reason">${e.reason}</p>`:""}\n        </div>\n        <div class="suggestion-actions">\n          ${"pending"===e.status?`\n            <button class="btn-icon approve-suggestion" data-id="${e.id}" title="Approve">\n              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <polyline points="20 6 9 17 4 12"></polyline>\n              </svg>\n            </button>\n            <button class="btn-icon reject-suggestion" data-id="${e.id}" title="Reject">\n              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <line x1="18" y1="6" x2="6" y2="18"></line>\n                <line x1="6" y1="6" x2="18" y2="18"></line>\n              </svg>\n            </button>\n          `:""}\n          <button class="btn-icon delete-suggestion" data-id="${e.id}" title="Delete">\n            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M3 6h18"></path>\n              <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>\n            </svg>\n          </button>\n        </div>\n      </div>\n    `})).join(""),attachSuggestionListeners()):e.innerHTML='<p class="empty-message">No suggestions yet</p>'}function attachSuggestionListeners(){document.querySelectorAll(".approve-suggestion").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=this.dataset.id;(await MulonData.updateSuggestionStatus(e,"approved")).success?(showToast("Suggestion approved","success"),renderSuggestionList()):showToast("Error approving suggestion","error")}))})),document.querySelectorAll(".reject-suggestion").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=this.dataset.id;(await MulonData.updateSuggestionStatus(e,"rejected")).success?(showToast("Suggestion rejected","success"),renderSuggestionList()):showToast("Error rejecting suggestion","error")}))})),document.querySelectorAll(".delete-suggestion").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=this.dataset.id;if(confirm("Delete this suggestion?")){(await MulonData.deleteSuggestion(e)).success?(showToast("Suggestion deleted","success"),renderSuggestionList()):showToast("Error deleting suggestion","error")}}))}))}let waitlistData=[],waitlistFilter="pending";function setupWaitlistManagement(){const e=document.getElementById("refreshWaitlistBtn");e&&e.addEventListener("click",loadWaitlist);const t=document.getElementById("approveAllWaitlistBtn");t&&t.addEventListener("click",(async()=>{if(!isAccessAllowed())return;if(!confirm("Approve ALL pending waitlist users? They will gain access to Mulon."))return;t.disabled=!0,t.textContent="Approving...";const e=waitlistData.filter((e=>"pending"===e.status));let s=0;for(const t of e){(await MulonData.updateWaitlistStatus(t.id,"approved")).success&&s++}showToast(`Approved ${s} users!`,"success"),t.disabled=!1,t.textContent="‚úì Approve All Pending",await loadWaitlist()})),document.querySelectorAll(".waitlist-filter-btn").forEach((e=>{e.addEventListener("click",(function(){document.querySelectorAll(".waitlist-filter-btn").forEach((e=>e.classList.remove("active"))),this.classList.add("active"),waitlistFilter=this.dataset.filter,renderWaitlist()}))}))}async function loadWaitlist(){const e=document.getElementById("waitlistList");e&&(e.innerHTML='<div class="loading-state">Loading waitlist...</div>'),waitlistData=await MulonData.getWaitlist(),updateWaitlistStats(),renderWaitlist()}function updateWaitlistStats(){const e=waitlistData.filter((e=>"pending"===e.status)).length,t=waitlistData.filter((e=>"approved"===e.status)).length,s=waitlistData.filter((e=>"rejected"===e.status)).length,n=document.getElementById("waitlistPendingCount"),a=document.getElementById("waitlistApprovedCount"),o=document.getElementById("waitlistRejectedCount"),i=document.getElementById("waitlistBadge");n&&(n.textContent=e),a&&(a.textContent=t),o&&(o.textContent=s),i&&(i.textContent=e,i.style.display=e>0?"inline-flex":"none")}function renderWaitlist(){const e=document.getElementById("waitlistList");if(!e)return;let t=waitlistData;"all"!==waitlistFilter&&(t=waitlistData.filter((e=>e.status===waitlistFilter))),t.sort(((e,t)=>{const s=e.joinedAt?.toDate?.()||new Date(e.joinedAt),n=t.joinedAt?.toDate?.()||new Date(t.joinedAt);return"pending"===waitlistFilter?s-n:n-s})),0!==t.length?(e.innerHTML=t.map(((e,t)=>{const s=e.joinedAt?.toDate?.()?e.joinedAt.toDate().toLocaleDateString():"Unknown",n="approved"===e.status?"approved":"rejected"===e.status?"rejected":"pending";return`\n      <div class="waitlist-item ${n}">\n        <div class="waitlist-item-info">\n          <span class="waitlist-position">#${t+1}</span>\n          <div class="waitlist-user">\n            <img src="${e.photoURL||""}" alt="" class="waitlist-avatar" onerror="this.style.display='none'">\n            <div class="waitlist-user-details">\n              <span class="waitlist-name">${e.displayName||"Unknown"}</span>\n              <span class="waitlist-email">${e.email||""}</span>\n            </div>\n          </div>\n          <span class="waitlist-joined">Joined: ${s}</span>\n          <span class="waitlist-status ${n}">${e.status}</span>\n        </div>\n        <div class="waitlist-item-actions">\n          ${"pending"===e.status?`\n            <button class="btn btn-sm btn-success approve-waitlist" data-id="${e.id}">‚úì Approve</button>\n            <button class="btn btn-sm btn-danger reject-waitlist" data-id="${e.id}">‚úó Reject</button>\n          `:"approved"===e.status?`\n            <button class="btn btn-sm btn-warning revoke-waitlist" data-id="${e.id}">Revoke</button>\n          `:`\n            <button class="btn btn-sm btn-success approve-waitlist" data-id="${e.id}">‚úì Approve</button>\n          `}\n        </div>\n      </div>\n    `})).join(""),attachWaitlistEventListeners()):e.innerHTML=`\n      <div class="waitlist-empty">\n        <span class="empty-icon">üìã</span>\n        <p>No ${"all"===waitlistFilter?"":waitlistFilter+" "}users on waitlist</p>\n      </div>\n    `}function attachWaitlistEventListeners(){document.querySelectorAll(".approve-waitlist").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=this.dataset.id;this.disabled=!0,this.textContent="...";(await MulonData.updateWaitlistStatus(e,"approved")).success?(showToast("User approved!","success"),await loadWaitlist()):(showToast("Error approving user","error"),this.disabled=!1,this.textContent="‚úì Approve")}))})),document.querySelectorAll(".reject-waitlist").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;const e=this.dataset.id;this.disabled=!0,this.textContent="...";(await MulonData.updateWaitlistStatus(e,"rejected")).success?(showToast("User rejected","success"),await loadWaitlist()):(showToast("Error rejecting user","error"),this.disabled=!1,this.textContent="‚úó Reject")}))})),document.querySelectorAll(".revoke-waitlist").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(!confirm("Revoke access for this user? They will be moved back to pending."))return;const e=this.dataset.id;this.disabled=!0,this.textContent="...";(await MulonData.updateWaitlistStatus(e,"pending")).success?(showToast("Access revoked","success"),await loadWaitlist()):(showToast("Error revoking access","error"),this.disabled=!1,this.textContent="Revoke")}))}))}let purchasesData=[],purchasesFilter="pending";function setupPurchasesManagement(){const e=document.getElementById("refreshPurchasesBtn");e&&e.addEventListener("click",loadPurchases),document.querySelectorAll(".purchases-filter-btn").forEach((e=>{e.addEventListener("click",(function(){document.querySelectorAll(".purchases-filter-btn").forEach((e=>e.classList.remove("active"))),this.classList.add("active"),purchasesFilter=this.dataset.filter,renderPurchases()}))}))}async function loadPurchases(){const e=document.getElementById("purchasesList");e&&(e.innerHTML='<div class="loading-state">Loading purchases...</div>');try{purchasesData=await MulonData.getPurchases(),updatePurchasesStats(),renderPurchases()}catch(t){console.error("Error loading purchases:",t),e&&(e.innerHTML='<div class="error-state">Error loading purchases</div>')}}function updatePurchasesStats(){const e=purchasesData.filter((e=>"pending"===e.status)).length,t=purchasesData.filter((e=>"completed"===e.status)).length,s=purchasesData.filter((e=>"completed"===e.status)).reduce(((e,t)=>e+(t.amount||0)),0),n=document.getElementById("purchasesPendingCount"),a=document.getElementById("purchasesCompletedCount"),o=document.getElementById("purchasesTotalRevenue"),i=document.getElementById("purchasesBadge");n&&(n.textContent=e),a&&(a.textContent=t),o&&(o.textContent="$"+s.toFixed(2)),i&&(i.textContent=e,i.style.display=e>0?"inline-flex":"none")}function renderPurchases(){const e=document.getElementById("purchasesList");if(!e)return;let t=purchasesData;"all"!==purchasesFilter&&(t=purchasesData.filter((e=>e.status===purchasesFilter))),t.sort(((e,t)=>{const s=e.timestamp?.toDate?.()||new Date(e.timestamp),n=t.timestamp?.toDate?.()||new Date(t.timestamp);return"pending"===purchasesFilter?s-n:n-s})),0!==t.length?(e.innerHTML=t.map((e=>{const t=e.timestamp?.toDate?.()||new Date(e.timestamp),s=t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),n=t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}),a="pending"===e.status?"status-pending":"completed"===e.status?"status-approved":"status-rejected",o="pending"===e.status?`\n      <button class="complete-purchase btn-primary" data-id="${e.id}">‚úì Mark Completed</button>\n      <button class="cancel-purchase btn-secondary" data-id="${e.id}">‚úó Cancel</button>\n    `:"completed"===e.status?'\n      <span class="completed-badge">‚úì Fulfilled</span>\n    ':'\n      <span class="cancelled-badge">‚úó Cancelled</span>\n    ';return`\n      <div class="purchase-item ${a}">\n        <div class="purchase-info">\n          <div class="purchase-user">\n            <strong>${e.userEmail||"Unknown User"}</strong>\n            <span class="purchase-username">${e.username||""}</span>\n          </div>\n          <div class="purchase-details">\n            <span class="purchase-pack">${e.packName||"Unknown Pack"}</span>\n            <span class="purchase-amount">$${(e.amount||0).toFixed(2)} USD</span>\n          </div>\n          <div class="purchase-meta">\n            <span class="purchase-date">${s} at ${n}</span>\n            <span class="purchase-status ${a}">${e.status}</span>\n          </div>\n        </div>\n        <div class="purchase-actions">\n          ${o}\n        </div>\n      </div>\n    `})).join(""),attachPurchaseEventListeners()):e.innerHTML=`\n      <div class="purchases-empty">\n        <span class="empty-icon">üí≥</span>\n        <p>No ${"all"===purchasesFilter?"":purchasesFilter+" "}purchases</p>\n      </div>\n    `}function attachPurchaseEventListeners(){document.querySelectorAll(".complete-purchase").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(!confirm("Mark this purchase as completed/fulfilled?"))return;const e=this.dataset.id;this.disabled=!0,this.textContent="Processing...";(await MulonData.updatePurchaseStatus(e,"completed")).success?(showToast("Purchase marked as completed!","success"),await loadPurchases()):(showToast("Error updating purchase","error"),this.disabled=!1,this.textContent="‚úì Mark Completed")}))})),document.querySelectorAll(".cancel-purchase").forEach((e=>{e.addEventListener("click",(async function(){if(!isAccessAllowed())return;if(!confirm("Cancel this purchase? The user will not receive items."))return;const e=this.dataset.id;this.disabled=!0,this.textContent="Cancelling...";(await MulonData.updatePurchaseStatus(e,"cancelled")).success?(showToast("Purchase cancelled","success"),await loadPurchases()):(showToast("Error cancelling purchase","error"),this.disabled=!1,this.textContent="‚úó Cancel")}))}))}