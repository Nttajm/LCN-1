import{initializeApp as e}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import{getFirestore as t,doc as n,getDoc as a,getDocs as r,collection as o,query as s,where as i}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import{getAuth as l,signInWithPopup as c,signOut as d,GoogleAuthProvider as u,onAuthStateChanged as m}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{calculateLevel as f,createLevelBadgeHTML as p}from"./level-utils.js";const y=e({apiKey:"AIzaSyAGcg43F94bWqUuyLH-AjghrAfduEVQ8ZM",authDomain:"overunder-ths.firebaseapp.com",projectId:"overunder-ths",storageBucket:"overunder-ths.firebasestorage.app",messagingSenderId:"690530120785",appId:"1:690530120785:web:36dc297cb517ac76cb7470",measurementId:"G-Q30T39R8VY"}),g=t(y),b=l(y),v=new u,h=o(g,"mulon_users"),w=o(g,"mulon"),E=o(g,"users"),k=o(g,"mulon_banned_devices"),L=o(g,"mulon_banned_emails");window.checkBanStatus=async function(){try{const e=b.currentUser,t=function(){let e=0;const t=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,(new Date).getTimezoneOffset(),navigator.hardwareConcurrency||"unknown",navigator.platform].join("|");for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e&=e;let n=localStorage.getItem("mulon_device_id");return n||(n="dev_"+Date.now()+"_"+Math.random().toString(36).substring(2,15),localStorage.setItem("mulon_device_id",n)),n+"_"+Math.abs(e).toString(36)}();if((await a(n(k,t))).exists())return console.log("Device is banned, redirecting..."),window.location.href="https://parismou.org/PMoU-Procedures/Library/banning",!0;if(e){if(e.email){const t=e.email.toLowerCase().replace(/[.#$[\]]/g,"_");if((await a(n(L,t))).exists())return console.log("Email is banned, redirecting..."),window.location.href="https://parismou.org/PMoU-Procedures/Library/banning",!0}const t=await a(n(h,e.uid));if(t.exists()&&!0===t.data().banned)return console.log("User is banned, redirecting..."),window.location.href="https://parismou.org/PMoU-Procedures/Library/banning",!0}return!1}catch(e){return console.error("Error checking ban status:",e),!1}};let B="profit",I=[],S=null,$={};function x(e){return window.FormatUtils?.formatWithCommas?window.FormatUtils.formatWithCommas(e):e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function N(e){if(window.FormatUtils?.formatBalance)return window.FormatUtils.formatBalance(e);const t=parseFloat(e)||0,[n,a]=t.toFixed(2).split(".");return`$${x(n)}.${a}`}function C(e){return e?e.split(" ").map((e=>e[0])).join("").toUpperCase().slice(0,2):"?"}async function U(){try{(await r(w)).forEach((e=>{$[e.id]=e.data()}))}catch(e){console.error("Error loading markets:",e)}}async function A(e){if(!e||0===e.length)return 0;let t=0;for(const n of e){const e=$[n.marketId];if(!e)continue;const a="yes"===n.choice?(e.yesPrice||50)/100:(e.noPrice||50)/100;t+=n.shares*a}return t}async function P(){F(!0);try{const[,e,t]=await Promise.all([U(),r(h),r(E)]),n=new Map;t.docs.forEach((e=>{const t=e.data();t.email&&n.set(t.email,t)}));const a=e.docs.filter((e=>!0!==e.data().banned)).map((async e=>{const t=e.data(),a=function(e){if(!e||0===e.length)return 0;let t=0;for(const n of e){const e=$[n.marketId];if(!e)continue;const a="yes"===n.choice?(e.yesPrice||50)/100:(e.noPrice||50)/100;t+=n.shares*a}return t}(t.positions||[]),r=function(e,t){const n=500,a=e.balance||500,r=e.cashOuts||[];let o=0;for(const e of r)"won"===e.result?o+=(e.payout||0)-(e.costBasis||0):"lost"===e.result&&(o-=e.costBasis||0);return a+t-n}(t,a);let o=t.displayName||"Anonymous",s="";if(t.email&&n.has(t.email)){const e=n.get(t.email);e.username&&(o=e.username),e.leaderStyle&&""!==e.leaderStyle.trim()&&(s=e.leaderStyle)}const i="number"!=typeof t.balance||isNaN(t.balance)?500:t.balance,l="number"!=typeof a||isNaN(a)?0:a,c="number"!=typeof r||isNaN(r)?0:r,d="number"!=typeof t.xps||isNaN(t.xps)?0:t.xps;return{id:e.id,displayName:o,photoURL:t.photoURL||null,avatarStyle:t.avatarStyle||"default",balance:i,portfolioValue:l,profit:c,positionsCount:(t.positions||[]).length,createdAt:t.createdAt,leaderStyle:s,xps:d}}));I=await Promise.all(a),_()}catch(e){console.error("Error loading leaderboard:",e),T()}finally{F(!1)}}function j(e){if(null==e)return 0;if("string"==typeof e){const t=parseFloat(e);return isNaN(t)?0:t}return"number"!=typeof e||isNaN(e)?0:e}function M(e){const t=document.getElementById("leaderboardRows"),n=document.getElementById("leaderboardTable");if(0===e.length)return void(n.style.display="none");n.style.display="block",document.querySelectorAll(".table-header-cell.sortable").forEach((e=>{e.classList.remove("active"),e.dataset.sort===B&&e.classList.add("active")}));t.innerHTML=e.map(((e,t)=>{const n=t+1,a=e.id===S,r=(e=>{switch(e){case 1:return"rank-1";case 2:return"rank-2";case 3:return"rank-3";default:return""}})(n),o=(e=>{switch(e){case 1:return"gold";case 2:return"silver";case 3:return"bronze";default:return""}})(n),s=e.leaderStyle?e.leaderStyle.split(" ").filter((e=>""!==e.trim())).join(" "):"",i=f(e.xps||0),l=p(i.level,"small");let c,d="";var u;e.avatarStyle&&e.avatarStyle.startsWith("gradient")?(d=`style="background: ${u=e.avatarStyle,{gradient1:"linear-gradient(135deg, #667eea, #764ba2)",gradient2:"linear-gradient(135deg, #11998e, #38ef7d)",gradient3:"linear-gradient(135deg, #fc4a1a, #f7b733)",gradient4:"linear-gradient(135deg, #141e30, #243b55)",gradient5:"linear-gradient(135deg, #ff9a9e, #fecfef)",gradient6:"linear-gradient(135deg, #00c853, #00e676)",gradient7:"linear-gradient(135deg, #232526, #414345)"}[u]||""};"`,c=`<span class="user-cell-avatar-initials">${C(e.displayName)}</span>`):c=e.photoURL?`<img src="${e.photoURL}" alt="${e.displayName}">`:`<span class="user-cell-avatar-initials">${C(e.displayName)}</span>`;const m=e.profit>=0?"positive":"negative",y="profit"===B?"main-stat "+m:"main-stat neutral",g=n<=3?(e=>{switch(e){case 1:return"ðŸ¥‡";case 2:return"ðŸ¥ˆ";case 3:return"ðŸ¥‰";default:return e}})(n):n;return`\n            <div class="leaderboard-row ${r} ${s} ${a?"current-user":""}" onclick="window.location.href='profile.html?id=${e.id}'" style="cursor: pointer;">\n                <div class="rank-cell">\n                    <span class="rank-badge ${o}">${g}</span>\n                </div>\n                <div class="user-cell">\n                    <div class="user-cell-avatar" ${d}>\n                        ${c}\n                        ${l}\n                    </div>\n                    <div class="user-cell-info">\n                        <div class="user-cell-name">${e.displayName}</div>\n                    </div>\n                </div>\n                <div class="stat-cell ${"profit"===B?y:m}">\n                    ${function(e){if(window.FormatUtils?.formatCurrency)return window.FormatUtils.formatCurrency(e);const t=parseFloat(e)||0,n=Math.abs(t),[a,r]=n.toFixed(2).split("."),o=x(a)+"."+r;return t>=0?`+$${o}`:`-$${o}`}(e.profit)}\n                </div>\n                <div class="stat-cell ${"balance"===B?"main-stat neutral":"neutral"}">\n                    ${N(e.balance)}\n                </div>\n                <div class="stat-cell ${"portfolio"===B?"main-stat neutral":"neutral"}">\n                    ${N(e.portfolioValue)}\n                </div>\n                <div class="view-profile-cell">\n                    <span class="view-profile-btn">View â†’</span>\n                </div>\n            </div>\n        `})).join("")}function _(){const e=[...I].sort(((e,t)=>{switch(B){case"profit":default:return j(t.profit)-j(e.profit);case"balance":return j(t.balance)-j(e.balance);case"portfolio":return j(t.portfolioValue)-j(e.portfolioValue)}}));0!==e.length?(document.getElementById("emptyState").style.display="none",M(e)):T()}function F(e){document.getElementById("loadingState").style.display=e?"flex":"none",document.getElementById("leaderboardTable").style.display=e?"none":"block"}function T(){document.getElementById("emptyState").style.display="flex",document.getElementById("leaderboardTable").style.display="none"}function R(){document.getElementById("userMenu");const e=document.getElementById("userDropdown"),t=document.getElementById("userAvatar"),r=document.getElementById("userInitials"),o=document.getElementById("userPhoto"),s=document.getElementById("userName"),i=document.getElementById("userEmail"),l=document.getElementById("signOutBtn"),u=document.getElementById("headerSignInBtn"),f=document.getElementById("userBalance"),p=document.getElementById("portfolioValue"),y=document.getElementById("userKeys");!function(){const e=document.getElementById("keysInfoBtn"),t=document.getElementById("keysTooltip");e&&t&&(e.addEventListener("click",(e=>{e.stopPropagation(),t.classList.toggle("active")})),document.addEventListener("click",(()=>{t.classList.remove("active")})))}(),t.addEventListener("click",(t=>{t.stopPropagation(),e.classList.toggle("active")})),document.addEventListener("click",(()=>{e.classList.remove("active")})),u.addEventListener("click",(async()=>{try{await c(b,v)}catch(e){console.error("Sign in error:",e)}})),l.addEventListener("click",(async()=>{try{await d(b)}catch(e){console.error("Sign out error:",e)}})),m(b,(async e=>{if(e){S=e.uid,r.style.display="none",o.style.display="block",o.src=e.photoURL||"",s.textContent=e.displayName||"User",i.textContent=e.email||"",l.style.display="flex",u.style.display="none",e.photoURL||(r.style.display="block",o.style.display="none",r.textContent=C(e.displayName));try{const t=await a(n(h,e.uid));if(t.exists()){const e=t.data();f.textContent=N(e.balance||500);const n=await A(e.positions||[]);p.textContent=N(n);const a=void 0!==e.keys?e.keys:15;y&&(y.innerHTML='<img src="/bp/EE/assets/ouths/key.png" alt="" class="key-icon"> '+a)}}catch(e){console.error("Error loading user data:",e)}_()}else S=null,r.style.display="block",o.style.display="none",r.textContent="?",s.textContent="Guest",i.textContent="Not signed in",l.style.display="none",u.style.display="flex",f.textContent="$500.00",p.textContent="$0.00",y&&(y.innerHTML='<img src="/bp/EE/assets/ouths/key.png" alt="" class="key-icon"> 15'),_()}))}document.addEventListener("DOMContentLoaded",(async()=>{if("function"==typeof window.checkBanStatus){if(await window.checkBanStatus())return}document.querySelectorAll(".filter-tab").forEach((e=>{e.addEventListener("click",(()=>{document.querySelectorAll(".filter-tab").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),B=e.dataset.filter,_()}))})),document.querySelectorAll(".table-header-cell.sortable").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.sort;t&&(B=t,document.querySelectorAll(".filter-tab").forEach((e=>{e.classList.toggle("active",e.dataset.filter===t)})),_())}))})),R(),function(){const e=document.querySelector(".search-box input");e&&e.addEventListener("input",(e=>{const t=e.target.value.toLowerCase().trim();if(!t)return void _();const n=I.filter((e=>e.displayName.toLowerCase().includes(t))),a=I;I=n,_(),I=a}))}(),P()}));