<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Casino - Mulon</title>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/casino.css">
  <link rel="stylesheet" href="css/chest-opener.css">
  <link rel="stylesheet" href="../css/standard.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <a href="index.html" class="logo">
        <span class="logo-text">Mulon (beta)</span>
      </a>
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
        <input type="text" placeholder="Search games...">
      </div>
    </div>
    <div class="header-right">
      <div class="balance-display">
        <div class="balance-item">
          <span class="balance-label">Balance</span>
          <span class="balance-amount" id="userBalance">$500.00</span>
        </div>
        <div class="balance-divider"></div>
        <div class="balance-item xps-item">
          <span class="balance-label">XPs</span>
          <span class="balance-amount xps-amount" id="userXPs">‚ö° 0</span>
        </div>
        <div class="balance-divider"></div>
        <div class="balance-item keys-item">
          <span class="balance-label">Keys <span class="keys-info-btn" id="keysInfoBtn">?</span></span>
          <span class="balance-amount keys-amount" id="userKeys"><img src="/bp/EE/assets/ouths/key.png" alt="" class="key-icon"> 15</span>
          <div class="keys-tooltip" id="keysTooltip">
            <h4><img src="/bp/EE/assets/ouths/key.png" alt="" class="key-icon"> Keys</h4>
            <p>Keys are a special currency that can be used for:</p>
            <ul>
              <li>Playing casino games</li>
              <li>Buying collectables</li>
            </ul>
            <p style="margin-top: 8px;"><strong>Earn Keys:</strong></p>
            <ul>
              <li>+3 keys for every winning prediction</li>
              <li>+1 key per day (daily login)</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="user-menu" id="userMenu">
        <div class="user-avatar" id="userAvatar">
          <span id="userInitials">?</span>
        </div>
        <div class="user-dropdown" id="userDropdown">
          <div class="user-info" id="userInfo">
            <span class="user-name" id="userName">Guest</span>
            <span class="user-email" id="userEmail">Not signed in</span>
          </div>
          <div class="dropdown-divider"></div>
          <button class="dropdown-item signin" id="headerSignInBtn">
            <svg viewBox="0 0 24 24" width="16" height="16">
              <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
            </svg>
            Sign In
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      <ul class="nav-links">
        <li><a href="index.html" class="nav-link">Home</a></li>
        <li><a href="marketplace.html" class="nav-link">Marketplace</a></li>
        <li><a href="leaderbaord.html" class="nav-link">Leaderboard</a></li>
        <li><a href="casino.html" class="nav-link active">Casino</a></li>
      </ul>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Online Users Counter -->
    <div class="online-users-bar">
      <span class="online-dot"></span>
      <span class="online-text"><span id="onlineCount">--</span> active gambling addicts online</span>
    </div>

    <!-- Level Bar (GTA Online Style) -->
    <div class="level-bar-container" id="levelBarContainer">
      <div class="level-bar-inner">
        <div class="level-badge" id="levelBadge">
          <span class="level-number" id="levelNumber">1</span>
        </div>
        <div class="level-progress-wrap">
          <div class="level-info">
            <span class="level-rank-name" id="levelRankName">Newcomer</span>
            <span class="level-xp" id="levelXP">0 / 200 XP</span>
          </div>
          <div class="level-progress-bar" id="levelProgressBar">
            <div class="level-progress-fill" id="levelProgressFill" style="width: 0%"></div>
            <div class="level-progress-segments">
              <span></span><span></span><span></span><span></span><span></span>
              <span></span><span></span><span></span><span></span><span></span>
            </div>
          </div>
        </div>
        <div class="level-next" id="levelNextBox">
          <span class="next-label">LVL</span>
          <span class="next-level" id="nextLevel">2</span>
        </div>
      </div>
    </div>

    <!-- Casino Header -->
    <div class="casino-header">
      <h1>üé∞ Casino</h1>
      <p>Play games with your Mulon balance and try your luck!</p>
    </div>

    <!-- Chests Section -->
    <div class="chests-section">
      <div class="chests-grid">
        <!-- XP Chest -->
        <div class="chest-card xp-chest" id="xpChest">
          <div class="chest-glow"></div>
          <div class="chest-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 8h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8z"></path>
              <path d="M21 8V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2"></path>
              <path d="M12 8v10"></path>
              <path d="M8 12h8"></path>
            </svg>
          </div>
          <div class="chest-info">
            <h3>XP Chest</h3>
            <p>Earn 100 XP to unlock</p>
          </div>
          <div class="chest-progress-container">
            <div class="chest-progress-bar">
              <div class="chest-progress-fill" id="xpChestProgress" style="width: 0%"></div>
            </div>
            <span class="chest-progress-text" id="xpChestProgressText">0 / 100 XP</span>
          </div>
          <button class="chest-open-btn" id="xpChestBtn" disabled>
            <span class="btn-text">Locked</span>
            <span class="btn-icon">üîí</span>
          </button>
        </div>

        <!-- $250 Chest -->
        <div class="chest-card money-chest uncommon-chest" id="uncommonChest">
          <div class="chest-glow"></div>
          <div class="chest-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 8h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8z"></path>
              <path d="M21 8V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2"></path>
              <path d="M12 8v10"></path>
              <circle cx="12" cy="13" r="2"></circle>
            </svg>
          </div>
          <div class="chest-info">
            <h3>Uncommon Chest</h3>
            <p>Uncommons & above items</p>
          </div>
          <div class="chest-price">
            <span class="price-tag">$250</span>
          </div>
          <button class="chest-open-btn" id="uncommonChestBtn">
            <span class="btn-text">Open</span>
            <span class="btn-icon">üéÅ</span>
          </button>
        </div>

        <!-- $1,000 Chest -->
        <div class="chest-card money-chest epic-chest" id="epicChest">
          <div class="chest-glow"></div>
          <div class="chest-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M3 8h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8z"></path>
              <path d="M21 8V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v2"></path>
              <path d="M12 8v10"></path>
              <path d="M9 11l3 3 3-3"></path>
              <path d="M9 15l3 3 3-3"></path>
            </svg>
          </div>
          <div class="chest-info">
            <h3>Epic Chest</h3>
            <p>epic with some legendary items</p>
          </div>
          <div class="chest-price">
            <span class="price-tag">$1,267</span>
            <span class="chest-reward"><img src="/bp/EE/assets/ouths/key.png" alt="" class="key-icon-small"> √ó10</span>
          </div>
          <button class="chest-open-btn" id="epicChestBtn">
            <span class="btn-text">Open</span>
            <span class="btn-icon">üéÅ</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Games Grid -->
    <div class="games-grid">
      <!-- Plinko Game Card -->
      <a href="casino/plinko.html" class="game-card">
        <div class="game-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="4" r="2"></circle>
            <circle cx="6" cy="8" r="1.5"></circle>
            <circle cx="12" cy="8" r="1.5"></circle>
            <circle cx="18" cy="8" r="1.5"></circle>
            <circle cx="4" cy="12" r="1.5"></circle>
            <circle cx="9" cy="12" r="1.5"></circle>
            <circle cx="15" cy="12" r="1.5"></circle>
            <circle cx="20" cy="12" r="1.5"></circle>
            <circle cx="6" cy="16" r="1.5"></circle>
            <circle cx="12" cy="16" r="1.5"></circle>
            <circle cx="18" cy="16" r="1.5"></circle>
            <path d="M3 20h18" stroke-width="2"></path>
          </svg>
        </div>
        <div class="game-info">
          <h3>Plinko</h3>
          <p>Drop the ball and watch it bounce through the pegs!</p>
        </div>
        <div class="game-meta">
          <span class="game-tag">üî• Popular</span>
          <span class="game-multiplier">Up to 1000x</span>
        </div>
      </a>

      <!-- Gems Game Card -->
      <a href="casino/gems.html" class="game-card">
        <div class="game-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M6 3h12l4 6-10 13L2 9z"></path>
            <path d="M12 22V9"></path>
            <path d="M2 9h20"></path>
            <path d="M6 3l6 6 6-6"></path>
          </svg>
        </div>
        <div class="game-info">
          <h3>Gems</h3>
          <p>Find the gems and avoid the mines to multiply your bet!</p>
        </div>
        <div class="game-meta">
          <span class="game-tag">üíé New</span>
          <span class="game-multiplier">Up to 24x</span>
        </div>
      </a>

      <!-- Roulette Game Card -->
      <a href="casino/roulette.html" class="game-card">
        <div class="game-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="6"></circle>
            <circle cx="12" cy="12" r="2"></circle>
            <line x1="12" y1="2" x2="12" y2="4"></line>
            <line x1="12" y1="20" x2="12" y2="22"></line>
            <line x1="2" y1="12" x2="4" y2="12"></line>
            <line x1="20" y1="12" x2="22" y2="12"></line>
            <line x1="4.93" y1="4.93" x2="6.34" y2="6.34"></line>
            <line x1="17.66" y1="17.66" x2="19.07" y2="19.07"></line>
            <line x1="4.93" y1="19.07" x2="6.34" y2="17.66"></line>
            <line x1="17.66" y1="6.34" x2="19.07" y2="4.93"></line>
          </svg>
        </div>
        <div class="game-info">
          <h3>Roulette</h3>
          <p>Spin the wheel and bet on numbers, colors, or ranges!</p>
        </div>
        <div class="game-meta">
          <span class="game-tag">üé∞ Classic</span>
          <span class="game-multiplier">Up to 35x</span>
        </div>
      </a>

      <!-- Dragon Tower Game Card -->
      <a href="casino/dragon-tower.html" class="game-card">
        <div class="game-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M3 21h18"></path>
            <path d="M5 21V7l7-4 7 4v14"></path>
            <path d="M9 21v-4h6v4"></path>
            <path d="M9 9h.01M15 9h.01M9 13h.01M15 13h.01"></path>
            <path d="M12 3v2"></path>
          </svg>
        </div>
        <div class="game-info">
          <h3>Dragon Tower</h3>
          <p>Climb the tower by choosing the right path. One wrong step and you fall!</p>
        </div>
        <div class="game-meta">
          <span class="game-tag">üêâ New</span>
          <span class="game-multiplier">Up to 5000x</span>
        </div>
      </a>

      <!-- Coming Soon Cards -->
      <div class="game-card coming-soon">
        <div class="game-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="2" y="4" width="20" height="16" rx="2"></rect>
            <path d="M12 8v4l2 2"></path>
          </svg>
        </div>
        <div class="game-info">
          <h3>Slots</h3>
          <p>Classic slot machine experience</p>
        </div>
        <div class="game-meta">
          <span class="game-tag coming-soon-tag">Coming Soon</span>
        </div>
      </div>

      <div class="game-card coming-soon">
        <div class="game-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
          </svg>
        </div>
        <div class="game-info">
          <h3>Dice</h3>
          <p>Roll the dice, predict the outcome</p>
        </div>
        <div class="game-meta">
          <span class="game-tag coming-soon-tag">Coming Soon</span>
        </div>
      </div>

      <div class="game-card coming-soon">
        <div class="game-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 2a10 10 0 0 1 0 20"></path>
            <path d="M12 6v6l4 2"></path>
          </svg>
        </div>
        <div class="game-info">
          <h3>Roulette</h3>
          <p>Spin the wheel, place your bets</p>
        </div>
        <div class="game-meta">
          <span class="game-tag coming-soon-tag">Coming Soon</span>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-inner">
      <span class="footer-logo">Mulon</span>
      <span class="footer-text">¬© 2026 Mulon Markets. For educational use only.</span>
    </div>
  </footer>

  <script type="module">
    import { CasinoAuth, CasinoDB } from './casino/js/casino-auth.js';
    import { initChestOpener, openChest } from './casino/js/chest-opener.js';
    
    // User menu dropdown toggle
    const userMenu = document.getElementById('userMenu');
    const userDropdown = document.getElementById('userDropdown');
    
    if (userMenu && userDropdown) {
      userMenu.addEventListener('click', (e) => {
        e.stopPropagation();
        userDropdown.classList.toggle('show');
      });
      
      document.addEventListener('click', () => {
        userDropdown.classList.remove('show');
      });
    }
    
    // Initialize auth and update balance display
    async function initCasinoAuth() {
      await CasinoAuth.init();
      
      // Update sign in button
      const signInBtn = document.getElementById('headerSignInBtn');
      if (signInBtn) {
        signInBtn.addEventListener('click', async () => {
          const result = await CasinoAuth.signIn();
          if (result.success) {
            updateUI();
          }
        });
      }
      
      CasinoAuth.onAuthStateChange((user, userData) => {
        updateUI();
      });
    }
    
    // ========================================
    // LEVEL TIERS CONFIGURATION
    // ========================================
    // Each tier defines: minLevel, name, colors, and optional effects
    // Colors: badge (gradient), progress (gradient), text, glow
    // Effects: animation class names to apply
    const LEVEL_TIERS = [
      {
        minLevel: 1,
        name: 'Grass toucher',
        colors: {
          badge: 'linear-gradient(135deg, #6b7280, #4b5563)',
          progress: 'linear-gradient(90deg, #6b7280, #9ca3af)',
          text: '#6b7280',
          glow: 'none'
        },
        effects: []
      },
      {
        minLevel: 3,
        name: 'Rookie',
        colors: {
          badge: 'linear-gradient(135deg, #22c55e, #16a34a)',
          progress: 'linear-gradient(90deg, #22c55e, #4ade80)',
          text: '#22c55e',
          glow: 'none'
        },
        effects: []
      },
      {
        minLevel: 5,
        name: 'pocket aces',
        colors: {
          badge: 'linear-gradient(135deg, #3b82f6, #2563eb)',
          progress: 'linear-gradient(90deg, #3b82f6, #60a5fa)',
          text: '#3b82f6',
          glow: 'none'
        },
        effects: []
      },
      {
        minLevel: 10,
        name: 'Veteran',
        colors: {
          badge: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
          progress: 'linear-gradient(90deg, #8b5cf6, #a78bfa)',
          text: '#8b5cf6',
          glow: '0 0 10px rgba(139, 92, 246, 0.3)'
        },
        effects: ['glow-pulse']
      },
      {
        minLevel: 15,
        name: 'Elite',
        colors: {
          badge: 'linear-gradient(135deg, #f59e0b, #d97706)',
          progress: 'linear-gradient(90deg, #f59e0b, #fbbf24)',
          text: '#f59e0b',
          glow: '0 0 15px rgba(245, 158, 11, 0.4)'
        },
        effects: ['glow-pulse']
      },
      {
        minLevel: 20,
        name: 'lil sigma',
        colors: {
          badge: 'linear-gradient(135deg, #ef4444, #dc2626)',
          progress: 'linear-gradient(90deg, #ef4444, #f87171)',
          text: '#ef4444',
          glow: '0 0 20px rgba(239, 68, 68, 0.5)'
        },
        effects: ['glow-pulse', 'fire-glow']
      },
      {
        minLevel: 30,
        name: 'Cronic Addict',
        colors: {
          badge: 'linear-gradient(135deg, #ec4899, #db2777)',
          progress: 'linear-gradient(90deg, #ec4899, #f472b6)',
          text: '#ec4899',
          glow: '0 0 25px rgba(236, 72, 153, 0.5)'
        },
        effects: ['glow-pulse', 'shimmer']
      },
      {
        minLevel: 50,
        name: 'GRANDMASTER',
        colors: {
          badge: 'linear-gradient(135deg, #14b8a6, #0d9488, #06b6d4)',
          progress: 'linear-gradient(90deg, #14b8a6, #2dd4bf, #06b6d4)',
          text: '#14b8a6',
          glow: '0 0 30px rgba(20, 184, 166, 0.6)'
        },
        effects: ['glow-pulse', 'shimmer', 'rainbow-border']
      },
      {
        minLevel: 100,
        name: 'on joels watch-list',
        colors: {
          badge: 'linear-gradient(135deg, #fbbf24, #f59e0b, #ef4444, #ec4899)',
          progress: 'linear-gradient(90deg, #fbbf24, #f59e0b, #ef4444, #ec4899)',
          text: '#fbbf24',
          glow: '0 0 40px rgba(251, 191, 36, 0.7)'
        },
        effects: ['glow-pulse', 'shimmer', 'rainbow-border', 'legendary']
      }
    ];
    
    // Get tier for a given level
    function getTierForLevel(level) {
      let tier = LEVEL_TIERS[0];
      for (const t of LEVEL_TIERS) {
        if (level >= t.minLevel) {
          tier = t;
        } else {
          break;
        }
      }
      return tier;
    }
    
    // Level calculation - each level is 200 XP
    function calculateLevel(totalXP) {
      const xpPerLevel = 200;
      const level = Math.floor(totalXP / xpPerLevel) + 1;
      const currentLevelXP = totalXP % xpPerLevel;
      const progressPercent = (currentLevelXP / xpPerLevel) * 100;
      
      return {
        level,
        currentXP: currentLevelXP,
        xpNeeded: xpPerLevel,
        progressPercent,
        totalXP,
        tier: getTierForLevel(level)
      };
    }
    
    function updateLevelBar(totalXP) {
      const levelData = calculateLevel(totalXP);
      const tier = levelData.tier;
      
      // Get elements
      const container = document.getElementById('levelBarContainer');
      const levelBadge = document.getElementById('levelBadge');
      const levelNumber = document.getElementById('levelNumber');
      const levelRankName = document.getElementById('levelRankName');
      const levelXP = document.getElementById('levelXP');
      const levelProgressFill = document.getElementById('levelProgressFill');
      const levelProgressBar = document.getElementById('levelProgressBar');
      const nextLevel = document.getElementById('nextLevel');
      const levelNextBox = document.getElementById('levelNextBox');
      
      // Update text content
      if (levelNumber) levelNumber.textContent = levelData.level;
      if (levelRankName) {
        levelRankName.textContent = tier.name;
        levelRankName.style.color = tier.colors.text;
      }
      if (levelXP) levelXP.textContent = `${levelData.currentXP} / ${levelData.xpNeeded} XP`;
      if (levelProgressFill) {
        levelProgressFill.style.width = `${levelData.progressPercent}%`;
        levelProgressFill.style.background = tier.colors.progress;
      }
      if (nextLevel) nextLevel.textContent = levelData.level + 1;
      
      // Apply tier colors
      if (levelBadge) {
        levelBadge.style.background = tier.colors.badge;
        levelBadge.style.boxShadow = tier.colors.glow;
      }
      
      // Remove all effect classes and apply new ones
      if (container) {
        container.classList.remove('glow-pulse', 'fire-glow', 'shimmer', 'rainbow-border', 'legendary');
        tier.effects.forEach(effect => container.classList.add(effect));
      }
    }
    
    function updateUI() {
      const user = CasinoAuth.currentUser;
      const balance = CasinoAuth.getBalance();
      const xps = CasinoAuth.getCharges ? CasinoAuth.getCharges() : (CasinoAuth.getXPs ? CasinoAuth.getXPs() : 0);
      
      // Update balance display
      const balanceEl = document.getElementById('userBalance');
      if (balanceEl) {
        balanceEl.textContent = '$' + balance.toFixed(2);
      }
      
      // Update xps display
      const xpsEl = document.getElementById('userXPs');
      if (xpsEl) {
        xpsEl.textContent = '‚ö° ' + xps;
      }
      
      // Update level bar
      updateLevelBar(xps);
      
      // Update user info
      const userName = document.getElementById('userName');
      const userEmail = document.getElementById('userEmail');
      const userInitials = document.getElementById('userInitials');
      const signInBtn = document.getElementById('headerSignInBtn');
      
      if (user) {
        if (userName) userName.textContent = user.displayName || 'User';
        if (userEmail) userEmail.textContent = user.email || '';
        if (userInitials) userInitials.textContent = (user.displayName || user.email || '?')[0].toUpperCase();
        if (signInBtn) signInBtn.textContent = 'Sign Out';
        if (signInBtn) {
          signInBtn.onclick = async () => {
            await CasinoAuth.signOut();
            location.reload();
          };
        }
      } else {
        if (userName) userName.textContent = 'Guest';
        if (userEmail) userEmail.textContent = 'Not signed in';
        if (userInitials) userInitials.textContent = '?';
        if (signInBtn) signInBtn.textContent = 'Sign In';
      }
      
      // Update chest progress
      updateChestFromDB();
    }
    
    initCasinoAuth();
    
    // ========================================
    // ONLINE USERS COUNTER
    // ========================================
    async function updateOnlineUsersCount() {
      const countEl = document.getElementById('onlineCount');
      if (!countEl) return;
      
      try {
        const count = await CasinoDB.getOnlineUsersCount(15); // Active in last 15 mins
        countEl.textContent = count;
      } catch (e) {
        // Fallback to random plausible number
        countEl.textContent = Math.floor(Math.random() * 30) + 15;
      }
    }
    
    // Update count on load and every 30 seconds
    setTimeout(updateOnlineUsersCount, 1000);
    setInterval(updateOnlineUsersCount, 30000);
    
    // Update user's last activity when they're on the page
    async function updateUserActivity() {
      if (CasinoAuth.currentUser && CasinoDB.updateLastActivity) {
        await CasinoDB.updateLastActivity();
      }
    }
    
    // Update activity on load and every 5 minutes
    setTimeout(updateUserActivity, 2000);
    setInterval(updateUserActivity, 5 * 60 * 1000);
    
    // ========================================
    // CHEST FUNCTIONALITY
    // ========================================
    const XP_PER_CHEST = 100;
    
    function updateXpChestProgress(totalXP, chestsClaimed = 0) {
      // Calculate how many chests are available based on total XP
      const totalChestsEarned = Math.floor(totalXP / XP_PER_CHEST);
      const availableChests = totalChestsEarned - chestsClaimed;
      
      // Progress towards next chest
      const xpIntoCurrentChest = totalXP % XP_PER_CHEST;
      const progress = (xpIntoCurrentChest / XP_PER_CHEST) * 100;
      
      const progressFill = document.getElementById('xpChestProgress');
      const progressText = document.getElementById('xpChestProgressText');
      const chestBtn = document.getElementById('xpChestBtn');
      const chestInfo = document.querySelector('.xp-chest .chest-info p');
      
      if (progressFill) progressFill.style.width = `${progress}%`;
      if (progressText) progressText.textContent = `${xpIntoCurrentChest} / ${XP_PER_CHEST} XP`;
      
      if (chestBtn) {
        if (availableChests > 0) {
          chestBtn.disabled = false;
          chestBtn.querySelector('.btn-text').textContent = `Open (${availableChests} available)`;
          chestBtn.querySelector('.btn-icon').textContent = 'üéÅ';
          if (chestInfo) chestInfo.textContent = `${availableChests} chest${availableChests > 1 ? 's' : ''} ready to open!`;
        } else {
          chestBtn.disabled = true;
          chestBtn.querySelector('.btn-text').textContent = 'Locked';
          chestBtn.querySelector('.btn-icon').textContent = 'üîí';
          if (chestInfo) chestInfo.textContent = `Earn ${XP_PER_CHEST - xpIntoCurrentChest} more XP to unlock`;
        }
      }
    }
    
    // Initialize chest buttons
    function initChests() {
      // Initialize the chest opener overlay
      initChestOpener();
      
      const xpChestBtn = document.getElementById('xpChestBtn');
      const uncommonChestBtn = document.getElementById('uncommonChestBtn');
      const epicChestBtn = document.getElementById('epicChestBtn');
      
      // XP Chest click handler
      if (xpChestBtn) {
        xpChestBtn.addEventListener('click', async () => {
          if (xpChestBtn.disabled) return;
          const result = await openChest('xp');
          if (result.success) {
            // Refresh UI after chest opens
            setTimeout(() => updateUI(), 500);
          }
        });
      }
      
      // Uncommon Chest ($250) click handler
      if (uncommonChestBtn) {
        uncommonChestBtn.addEventListener('click', async () => {
          const result = await openChest('uncommon');
          if (result.success) {
            // Refresh UI after chest opens to show new balance
            setTimeout(() => updateUI(), 500);
          }
        });
      }
      
      // Epic Chest ($1,000) click handler
      if (epicChestBtn) {
        epicChestBtn.addEventListener('click', async () => {
          const result = await openChest('epic');
          if (result.success) {
            // Refresh UI after chest opens to show new balance
            setTimeout(() => updateUI(), 500);
          }
        });
      }
      
      // Update XP chest progress based on current XP and chests claimed
      updateChestFromDB();
    }
    
    async function updateChestFromDB() {
      const user = CasinoAuth.currentUser;
      const xps = CasinoAuth.getCharges ? CasinoAuth.getCharges() : (CasinoAuth.getXPs ? CasinoAuth.getXPs() : 0);
      
      // Get number of XP chests claimed from database (or localStorage as fallback)
      let chestsClaimed = 0;
      try {
        if (user && CasinoDB && CasinoDB.getUser) {
          const userData = await CasinoDB.getUser(user.uid);
          if (userData && typeof userData.xpChestsClaimed === 'number') {
            chestsClaimed = userData.xpChestsClaimed;
          }
        } else {
          // For guests, use localStorage
          chestsClaimed = parseInt(localStorage.getItem('xpChestsClaimed') || '0');
        }
      } catch (e) {
        console.error('Error getting chest data:', e);
        chestsClaimed = parseInt(localStorage.getItem('xpChestsClaimed') || '0');
      }
      
      console.log('XP Chest Debug:', { xps, chestsClaimed, totalEarned: Math.floor(xps / XP_PER_CHEST), available: Math.floor(xps / XP_PER_CHEST) - chestsClaimed });
      updateXpChestProgress(xps, chestsClaimed);
    }
    
    // Initialize chests when DOM is ready
    setTimeout(initChests, 500);
  </script>
</body>
</html>
